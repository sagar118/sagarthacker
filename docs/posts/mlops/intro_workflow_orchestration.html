<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sagar Thacker">
<meta name="dcterms.date" content="2023-06-05">
<meta name="description" content="Prefect is an open-source workflow orchestration tool that helps you automate and manage the flow of work across your data stack.">

<title>Beyond the Dataset - Prefect: An Workflow Orchestration Tool</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-17YZDMEKH1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-17YZDMEKH1', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="Beyond the Dataset - Prefect: An Workflow Orchestration Tool">
<meta name="twitter:description" content="Prefect is an open-source workflow orchestration tool that helps you automate and manage the flow of work across your data stack.">
<meta name="twitter:image" content="https://sagarthacker.com/posts/mlops/images/intro_prefect/workflow.png">
<meta name="twitter:creator" content="@sagarthacker118">
<meta name="twitter:site" content="@sagarthacker">
<meta name="twitter:image-height" content="1039">
<meta name="twitter:image-width" content="2829">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Beyond the Dataset</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Prefect: An Workflow Orchestration Tool</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                  <div>
        <div class="description">
          Prefect is an open-source workflow orchestration tool that helps you automate and manage the flow of work across your data stack.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">MLOps</div>
                <div class="quarto-category">Prefect</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Sagar Thacker </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 5, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-workflow-orchestration" id="toc-what-is-workflow-orchestration" class="nav-link active" data-scroll-target="#what-is-workflow-orchestration">What is Workflow Orchestration?</a></li>
  <li><a href="#negative-engineering" id="toc-negative-engineering" class="nav-link" data-scroll-target="#negative-engineering">Negative Engineering</a></li>
  <li><a href="#prefect" id="toc-prefect" class="nav-link" data-scroll-target="#prefect">Prefect</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#prefect-flow" id="toc-prefect-flow" class="nav-link" data-scroll-target="#prefect-flow">Prefect Flow</a></li>
  <li><a href="#download-the-dataset" id="toc-download-the-dataset" class="nav-link" data-scroll-target="#download-the-dataset">Download the dataset</a></li>
  <li><a href="#preprocess-the-data" id="toc-preprocess-the-data" class="nav-link" data-scroll-target="#preprocess-the-data">Preprocess the data</a></li>
  <li><a href="#train-the-model" id="toc-train-the-model" class="nav-link" data-scroll-target="#train-the-model">Train the model</a></li>
  <li><a href="#create-a-flow" id="toc-create-a-flow" class="nav-link" data-scroll-target="#create-a-flow">Create a flow</a></li>
  <li><a href="#create-a-subflow" id="toc-create-a-subflow" class="nav-link" data-scroll-target="#create-a-subflow">Create a subflow</a></li>
  <li><a href="#run-the-flow" id="toc-run-the-flow" class="nav-link" data-scroll-target="#run-the-flow">Run the flow</a></li>
  </ul></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further Reading</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Prefect is an open-source workflow orchestration tool that helps you automate and manage the flow of work across your data stack.</p>
<p>Prefect is built on Python and uses a modular architecture that makes it easy to build and deploy complex workflows. Prefect also includes a rich set of features for monitoring, debugging, and managing your workflows.</p>
<p>Before we dive into Prefect, let’s first understand what is workflow orchestration, why do we need it, and where does Prefect come into play.</p>
<section id="what-is-workflow-orchestration" class="level2">
<h2 class="anchored" data-anchor-id="what-is-workflow-orchestration">What is Workflow Orchestration?</h2>
<p>Building a ML system has a lot of moving parts. We have to deal with data collection, data preprocessing, model training, model serving, etc. Each of these steps can be further broken down into sub-steps. For example, data preprocessing can be broken down into feature engineering, feature selection, etc.</p>
<p>Workflow Orchestration is the process of automating and managing the flow of work across these steps. It helps us build complex workflows by combining multiple steps together. It also helps us manage the dependencies between these steps.</p>
<p><img src="./images/intro_prefect/workflow.png" class="img-fluid"></p>
</section>
<section id="negative-engineering" class="level2">
<h2 class="anchored" data-anchor-id="negative-engineering">Negative Engineering</h2>
<p>Inspite of building a robust system, there are chances that something might go wrong. For example, the data might not be available, the model might fail to train, etc.</p>
<p><img src="./images/intro_prefect/workflow_failed.png" class="img-fluid"></p>
<p>Often time while developing any application, we find ourselves spending a lot of time fixing bugs and making sure that everything works as expected. We spend time writing code to handle edge cases and make sure that our application is robust enough to handle any unexpected situation. Exmaples of such situations are:</p>
<ul>
<li>Writing Retries logic when APIs go down</li>
<li>Build Notifications for when a job fails</li>
<li>Record logs for observability and debugging</li>
<li>Write conditional logic to handle edge cases</li>
<li>Handle cases when requests timeouts or fails</li>
</ul>
<p>Negative Engineering refers to ideology that we spend most of our time writing code to handle edge cases rather than writing code that actually solves the problem. This is where Workflow Orchestration comes into play.</p>
<p>Worflow Orchestration tools provide set of features off the shelf that aim to eliminate the need for negative engineering. These tools provide features like retries, notifications, logging, lineage tracking, etc. out of the box.</p>
</section>
<section id="prefect" class="level2">
<h2 class="anchored" data-anchor-id="prefect">Prefect</h2>
<p>Prefect aims to eliminate the need for negative engineering by providing a rich set of features out of the box.</p>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<p>It is a good practice to create a virtual environment for each project. This helps us keep our dependencies separate and avoid any version conflicts.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="va">fastparquet</span><span class="op">=</span>=2023.4.0</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="va">mlflow</span><span class="op">=</span>=2.3.1</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="va">pandas</span><span class="op">=</span>=2.0.1</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="va">prefect</span><span class="op">=</span>=2.10.8</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="va">scikit_learn</span><span class="op">=</span>=1.2.2</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="va">xgboost</span><span class="op">=</span>=1.7.5</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="ex">psycopg2-binary==2.9.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create a virtual environment named <code>venv</code> and install all the dependencies.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Create a virtual environment</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">conda</span> create <span class="at">-p</span> venv python=3.10 <span class="at">-y</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># Activate the virtual environment</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="ex">conda</span> activate venv/</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># Install all the dependencies</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt <span class="at">--no-cache-dir</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="prefect-flow" class="level3">
<h3 class="anchored" data-anchor-id="prefect-flow">Prefect Flow</h3>
<p>We will be using the <a href="https://www1.nyc.gov/site/tlc/about/tlc-trip-record-data.page">NYC Taxi Dataset</a> for this tutorial. The dataset contains information about green taxi trips in New York City. The dataset is available in parquet format.</p>
<p>Steps that we’ll cover:</p>
<ol type="1">
<li>We’ll download the dataset from the NY Taxi website and load it into a pandas dataframe.</li>
<li>Preprocess the data.</li>
<li>Train a model on the preprocessed data.</li>
<li>Log the model and the metrics to MLflow.</li>
</ol>
<p>You’ll wonder where do we use Prefect in this? Answer is in each step.</p>
<p>We’ll go through each step in detail. At the end you’ll find the complete code for the workflow.</p>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;plaintext&quot;}">
<details>
<summary>Import Libraries</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="im">import</span> pickle</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="im">import</span> pathlib</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="im">import</span> scipy</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="im">import</span> mlflow</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="im">import</span> sklearn</span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="im">import</span> argparse</span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="im">from</span> sklearn.feature_extraction <span class="im">import</span> DictVectorizer</span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="im">from</span> prefect.tasks <span class="im">import</span> task_input_hash</span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="im">from</span> datetime <span class="im">import</span> timedelta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Two most important building blocks in Prefect are <code>Task</code> and <code>Flow</code>. We’ll start by importing these two. More on these later.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="im">from</span> prefect <span class="im">import</span> task, flow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="download-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="download-the-dataset">Download the dataset</h3>
<p>We have created a python function named <code>fetch</code> what will download the data from the NY Taxi website and save it to the <code>data</code> directory.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Fetch Data"</span>, log_prints<span class="op">=</span><span class="va">True</span>, retries<span class="op">=</span><span class="dv">3</span>, cache_key_fn<span class="op">=</span>task_input_hash, cache_expiration<span class="op">=</span>timedelta(days<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">def</span> fetch(year: <span class="bu">int</span>, month: <span class="bu">int</span>, color: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="co">"""Fetches data from the NYC Taxi dataset and saves it locally"""</span></span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="co"># Download the data from the NYC Taxi dataset</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a>    url <span class="op">=</span> <span class="ss">f"https://d37ci6vzurychx.cloudfront.net/trip-data/</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    file_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span></span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a>    pathlib.Path(<span class="st">"data"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a>    os.system(<span class="ss">f"wget </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss"> -O ./data/</span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s understand what is happening here.</p>
<p>The function is defined in the same way as any other python function. The only difference is that we have added a decorator <code>@task</code> to the function. This decorator converts the python function into a Prefect Task. The decorator takes a few arguments:</p>
<ul>
<li><code>@task</code> is a decorator that converts a python function into a Prefect Task.</li>
<li><code>name</code> is the name of the task. This is used to identify the task in the Prefect UI.</li>
<li><code>log_prints</code> is a boolean flag that tells Prefect to log the output of the task.</li>
<li><code>retries</code> is the number of times the task should be retried in case of failure.</li>
<li><code>cache_key_fn</code> is a function that returns a unique key for the task. This is used to cache the output of the task.</li>
<li><code>cache_expiration</code> is the time after which the cache should expire.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Terminology Alert: Task
</div>
</div>
<div class="callout-body-container callout-body">
<p>A task is a unit of work that needs to be done. It can be anything from downloading a file to training a model. Prefect provides a decorator <code>@task</code> that converts a python function into a Prefect Task.</p>
<p>Imagine you are preparing a sandwich. To prepare a delicious sandwich you need to perform a few tasks like: get the bread, apply butter, add cheese, cut down the veggies, etc. Each of these tasks is a unit of work that needs to be done to prepare the sandwich. In Prefect, each of these tasks can be represented as a Prefect Task.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>To enable caching we specified a <code>cache_key_fn</code> which is a function that returns a cache key on our task. We cachec our task based on its input by using <code>task_input_hash</code> which is a function that returns a unique hash for the input of the task.</p>
<p>It hashes all inputs to the task and returns a unique hash. If the task inputs do not change, the hash will remain the same and the cachec results are used instead of running the task again until cache expires.</p>
<p>We also specified a <code>cache_expiration</code> of 1 day. This means that the cache will expire after 1 day.</p>
</div>
</div>
<p>This is a good practice while working with large datasets. It helps us avoid downloading the same dataset again and again.</p>
<p>Next up, we have function named <code>read_data</code> that takes a filename and load the data into a pandas dataframe.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Read a Parquet file"</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">def</span> read_data(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="co">"""Read data into DataFrame"""</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>    df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a>    df.lpep_dropoff_datetime <span class="op">=</span> pd.to_datetime(df.lpep_dropoff_datetime)</span>
<span id="cb6-7"><a href="#cb6-7"></a>    df.lpep_pickup_datetime <span class="op">=</span> pd.to_datetime(df.lpep_pickup_datetime)</span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a>    df[<span class="st">"duration"</span>] <span class="op">=</span> df.lpep_dropoff_datetime <span class="op">-</span> df.lpep_pickup_datetime</span>
<span id="cb6-10"><a href="#cb6-10"></a>    df.duration <span class="op">=</span> df.duration.<span class="bu">apply</span>(<span class="kw">lambda</span> td: td.total_seconds() <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>    df <span class="op">=</span> df[(df.duration <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df.duration <span class="op">&lt;=</span> <span class="dv">60</span>)]</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a>    categorical <span class="op">=</span> [<span class="st">"PULocationID"</span>, <span class="st">"DOLocationID"</span>]</span>
<span id="cb6-15"><a href="#cb6-15"></a>    df[categorical] <span class="op">=</span> df[categorical].astype(<span class="bu">str</span>)</span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This function is also decorated with <code>@task</code> decorator. Nothing new here.</p>
</section>
<section id="preprocess-the-data" class="level3">
<h3 class="anchored" data-anchor-id="preprocess-the-data">Preprocess the data</h3>
<p>Now that we have the data, we need to preprocess it before we can train a model on it. We’ll create a function named <code>add_features</code> that combines <code>PULocationID</code> and <code>DOLocationID</code>. Also, we’ll represent our features using the DictVectorizer. We’ll perform these steps for both training and validation data.</p>
<p>Again, we’ll decorate the function with <code>@task</code> decorator.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Add Features"</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">def</span> add_features(df_train: pd.DataFrame, df_val: pd.DataFrame) <span class="op">-&gt;</span> <span class="bu">tuple</span>([</span>
<span id="cb7-3"><a href="#cb7-3"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb7-4"><a href="#cb7-4"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb7-5"><a href="#cb7-5"></a>        np.ndarray,</span>
<span id="cb7-6"><a href="#cb7-6"></a>        np.ndarray,</span>
<span id="cb7-7"><a href="#cb7-7"></a>        sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb7-8"><a href="#cb7-8"></a>    ]):</span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="co">"""Add features to the model"""</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>    df_train[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_train[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_train[<span class="st">"DOLocationID"</span>]</span>
<span id="cb7-11"><a href="#cb7-11"></a>    df_val[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_val[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_val[<span class="st">"DOLocationID"</span>]</span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a>    categorical <span class="op">=</span> [<span class="st">"PU_DO"</span>]  <span class="co">#['PULocationID', 'DOLocationID']</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>    numerical <span class="op">=</span> [<span class="st">"trip_distance"</span>]</span>
<span id="cb7-15"><a href="#cb7-15"></a></span>
<span id="cb7-16"><a href="#cb7-16"></a>    dv <span class="op">=</span> DictVectorizer()</span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a>    train_dicts <span class="op">=</span> df_train[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb7-19"><a href="#cb7-19"></a>    X_train <span class="op">=</span> dv.fit_transform(train_dicts)</span>
<span id="cb7-20"><a href="#cb7-20"></a></span>
<span id="cb7-21"><a href="#cb7-21"></a>    val_dicts <span class="op">=</span> df_val[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb7-22"><a href="#cb7-22"></a>    X_val <span class="op">=</span> dv.transform(val_dicts)</span>
<span id="cb7-23"><a href="#cb7-23"></a></span>
<span id="cb7-24"><a href="#cb7-24"></a>    y_train <span class="op">=</span> df_train[<span class="st">"duration"</span>].values</span>
<span id="cb7-25"><a href="#cb7-25"></a>    y_val <span class="op">=</span> df_val[<span class="st">"duration"</span>].values</span>
<span id="cb7-26"><a href="#cb7-26"></a>    <span class="cf">return</span> X_train, X_val, y_train, y_val, dv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="train-the-model" class="level3">
<h3 class="anchored" data-anchor-id="train-the-model">Train the model</h3>
<p>We have an XGBoost model that we want to train. We’ll create a function named <code>train_best_model</code> that takes the training and validation data along with the DictVectorizer and trains the model. We’ll use the best hyperparameters that we found seperately.</p>
<p>One awesome thing you’ll observe is that we are also using mlflow to log the model and the hyperparameters. This is a great way to track the model performance and the hyperparameters that were used to train the model.</p>
<p>Due to the <code>log_prints</code> flag, Prefect will log the output of the task including the output logs from mlflow. This is a great way to visualize the logs in the Prefect UI.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Train Model"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">def</span> train_best_model(</span>
<span id="cb8-3"><a href="#cb8-3"></a>    X_train: scipy.sparse._csr.csr_matrix,</span>
<span id="cb8-4"><a href="#cb8-4"></a>    X_val: scipy.sparse._csr.csr_matrix,</span>
<span id="cb8-5"><a href="#cb8-5"></a>    y_train: np.ndarray,</span>
<span id="cb8-6"><a href="#cb8-6"></a>    y_val: np.ndarray,</span>
<span id="cb8-7"><a href="#cb8-7"></a>    dv: sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb8-8"><a href="#cb8-8"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb8-9"><a href="#cb8-9"></a>    <span class="co">"""train a model with best hyperparams and write everything out"""</span></span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb8-12"><a href="#cb8-12"></a>        train <span class="op">=</span> xgb.DMatrix(X_train, label<span class="op">=</span>y_train)</span>
<span id="cb8-13"><a href="#cb8-13"></a>        valid <span class="op">=</span> xgb.DMatrix(X_val, label<span class="op">=</span>y_val)</span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a>        best_params <span class="op">=</span> {</span>
<span id="cb8-16"><a href="#cb8-16"></a>            <span class="st">"learning_rate"</span>: <span class="fl">0.09585355369315604</span>,</span>
<span id="cb8-17"><a href="#cb8-17"></a>            <span class="st">"max_depth"</span>: <span class="dv">30</span>,</span>
<span id="cb8-18"><a href="#cb8-18"></a>            <span class="st">"min_child_weight"</span>: <span class="fl">1.060597050922164</span>,</span>
<span id="cb8-19"><a href="#cb8-19"></a>            <span class="st">"objective"</span>: <span class="st">"reg:linear"</span>,</span>
<span id="cb8-20"><a href="#cb8-20"></a>            <span class="st">"reg_alpha"</span>: <span class="fl">0.018060244040060163</span>,</span>
<span id="cb8-21"><a href="#cb8-21"></a>            <span class="st">"reg_lambda"</span>: <span class="fl">0.011658731377413597</span>,</span>
<span id="cb8-22"><a href="#cb8-22"></a>            <span class="st">"seed"</span>: <span class="dv">42</span>,</span>
<span id="cb8-23"><a href="#cb8-23"></a>        }</span>
<span id="cb8-24"><a href="#cb8-24"></a></span>
<span id="cb8-25"><a href="#cb8-25"></a>        mlflow.log_params(best_params)</span>
<span id="cb8-26"><a href="#cb8-26"></a></span>
<span id="cb8-27"><a href="#cb8-27"></a>        booster <span class="op">=</span> xgb.train(</span>
<span id="cb8-28"><a href="#cb8-28"></a>            params<span class="op">=</span>best_params,</span>
<span id="cb8-29"><a href="#cb8-29"></a>            dtrain<span class="op">=</span>train,</span>
<span id="cb8-30"><a href="#cb8-30"></a>            num_boost_round<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb8-31"><a href="#cb8-31"></a>            evals<span class="op">=</span>[(valid, <span class="st">"validation"</span>)],</span>
<span id="cb8-32"><a href="#cb8-32"></a>            early_stopping_rounds<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb8-33"><a href="#cb8-33"></a>        )</span>
<span id="cb8-34"><a href="#cb8-34"></a></span>
<span id="cb8-35"><a href="#cb8-35"></a>        y_pred <span class="op">=</span> booster.predict(valid)</span>
<span id="cb8-36"><a href="#cb8-36"></a>        rmse <span class="op">=</span> mean_squared_error(y_val, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-37"><a href="#cb8-37"></a>        mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb8-38"><a href="#cb8-38"></a></span>
<span id="cb8-39"><a href="#cb8-39"></a>        pathlib.Path(<span class="st">"models"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-40"><a href="#cb8-40"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/preprocessor.b"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f_out:</span>
<span id="cb8-41"><a href="#cb8-41"></a>            pickle.dump(dv, f_out)</span>
<span id="cb8-42"><a href="#cb8-42"></a>        mlflow.log_artifact(<span class="st">"models/preprocessor.b"</span>, artifact_path<span class="op">=</span><span class="st">"preprocessor"</span>)</span>
<span id="cb8-43"><a href="#cb8-43"></a></span>
<span id="cb8-44"><a href="#cb8-44"></a>        mlflow.xgboost.log_model(booster, artifact_path<span class="op">=</span><span class="st">"models_mlflow"</span>)</span>
<span id="cb8-45"><a href="#cb8-45"></a>    <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, we have our indenpendent tasks ready. Let’s create a flow that will run these tasks in the order we want.</p>
</section>
<section id="create-a-flow" class="level3">
<h3 class="anchored" data-anchor-id="create-a-flow">Create a flow</h3>
<p>We’ll create a flow named <code>main_flow</code> that will run the tasks in the order we want. We’ll also set the <code>name</code> of the flow to “Main Flow”. This is a great way to identify the flow in the Prefect UI.</p>
<p>Observe that yet again the flow is simply a function decorated with <code>@flow</code> decorator. We’ll also set the <code>params</code> argument to the flow. These paramarater also get recorded in the Prefect UI which can be very useful to track the flow runs.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Terminology Alert: Flow
</div>
</div>
<div class="callout-body-container callout-body">
<p>A flow is a collection of tasks that are executed in a particular order. A flow is a function decorated with <code>@flow</code> decorator. The flow function can take arguments and return values.</p>
<p>Imagine flow is a container that holds all the tasks and the order in which they are executed. Making a delicious sandwich is a flow and the actions you take to make the sandwich are the tasks.</p>
</div>
</div>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="at">@flow</span>(name<span class="op">=</span><span class="st">"Main Flow"</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="kw">def</span> main_flow(params):</span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="co">"""Main flow of the program"""</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>    </span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="co"># MLflow settings</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>    mlflow.set_tracking_uri(<span class="st">"sqlite:///mlflow.db"</span>)</span>
<span id="cb9-7"><a href="#cb9-7"></a>    mlflow.set_experiment(<span class="st">"nyc-taxi-experiment"</span>)</span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a>    <span class="co"># Download and read data</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>    df_train, df_val <span class="op">=</span> download_and_read(params.years, params.months, params.color)</span>
<span id="cb9-11"><a href="#cb9-11"></a></span>
<span id="cb9-12"><a href="#cb9-12"></a>    <span class="co"># Transform</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>    X_train, X_val, y_train, y_val, dv <span class="op">=</span> add_features(df_train, df_val)</span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a>    <span class="co"># Train</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>    train_best_model(X_train, X_val, y_train, y_val, dv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you observe closely, you’ll notice that we have a <code>download_and_read</code> function but we didn’t define that anywhere to avoid confusion until now. We’ll define that function next but that function will be a <code>Subflow</code> in our main flow.</p>
</section>
<section id="create-a-subflow" class="level3">
<h3 class="anchored" data-anchor-id="create-a-subflow">Create a subflow</h3>
<p>Image a subflow as a flow within a flow. A subflow is a function decorated with the same <code>@flow</code> decorator but it is called from within another flow. A subflow can also take arguments and return values.</p>
<p>We’ll create a subflow named <code>download_and_read</code> that will call the previously defined functions (tasks) to download the data and read it into a pandas dataframe. We’ll also set the <code>name</code> of the subflow to “Download and Read”. This is a great way to identify the subflow in the Prefect UI.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a><span class="at">@flow</span>(name<span class="op">=</span><span class="st">"Subflow - Download and Read Data"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="kw">def</span> download_and_read(years: <span class="bu">list</span>, months: <span class="bu">list</span>, color: <span class="bu">str</span>):</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="co"># Download the data from the NYC Taxi dataset</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="cf">for</span> year <span class="kw">in</span> years:</span>
<span id="cb10-5"><a href="#cb10-5"></a>        <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb10-6"><a href="#cb10-6"></a>            <span class="bu">print</span>(<span class="ss">f"Download: Year-Month: </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-7"><a href="#cb10-7"></a>            fetch(year, month, color)</span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a>    <span class="co"># Read the data into a DataFrame</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>    track_data <span class="op">=</span>[[], []]</span>
<span id="cb10-11"><a href="#cb10-11"></a>    df_train <span class="op">=</span> pd.DataFrame()</span>
<span id="cb10-12"><a href="#cb10-12"></a>    <span class="cf">for</span> month <span class="kw">in</span> months[:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb10-13"><a href="#cb10-13"></a>        <span class="bu">print</span>(<span class="ss">f"Read: Year-Month: </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss"> (</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-14"><a href="#cb10-14"></a>        df <span class="op">=</span> read_data(<span class="ss">f"./data/</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span>)</span>
<span id="cb10-15"><a href="#cb10-15"></a>        df_train <span class="op">=</span> pd.concat([df_train, df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-16"><a href="#cb10-16"></a>        track_data[<span class="dv">0</span>].append(month)</span>
<span id="cb10-17"><a href="#cb10-17"></a></span>
<span id="cb10-18"><a href="#cb10-18"></a>    <span class="bu">print</span>(<span class="ss">f"Read: Year-Month: </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>months[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:0&gt;2}</span><span class="ss"> (</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-19"><a href="#cb10-19"></a>    df_val <span class="op">=</span> read_data(<span class="ss">f"./data/</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>months[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span>)</span>
<span id="cb10-20"><a href="#cb10-20"></a>    track_data[<span class="dv">1</span>].append(months[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb10-21"><a href="#cb10-21"></a></span>
<span id="cb10-22"><a href="#cb10-22"></a>    <span class="bu">print</span>(<span class="ss">f"Training data consists of months: </span><span class="sc">{</span>track_data[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-23"><a href="#cb10-23"></a>    <span class="bu">print</span>(<span class="ss">f"Validation data consists of months: </span><span class="sc">{</span>track_data[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-24"><a href="#cb10-24"></a></span>
<span id="cb10-25"><a href="#cb10-25"></a>    <span class="cf">return</span> df_train, df_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Terminology Alert: Subflow
</div>
</div>
<div class="callout-body-container callout-body">
<p>A subflow is a flow within a flow. A subflow is a function decorated with <code>@flow</code> decorator. The subflow function can take arguments and return values.</p>
<p>Imagine you want to make a spicy sauce to have with your sandwich. To make a sauce you need to follow a recipe with multiple steps. Consider this as a subflow within the flow of making a sandwich.</p>
</div>
</div>
</section>
<section id="run-the-flow" class="level3">
<h3 class="anchored" data-anchor-id="run-the-flow">Run the flow</h3>
<p>We’ll run the script by calling the <code>main_flow</code> with the necessary arguments.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb11-2"><a href="#cb11-2"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">'Ingest CSV data to Postgres'</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a>    parser.add_argument(<span class="st">"--years"</span>, nargs<span class="op">=</span><span class="st">"+"</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Data from year"</span>)</span>
<span id="cb11-5"><a href="#cb11-5"></a>    parser.add_argument(<span class="st">"--months"</span>, nargs<span class="op">=</span><span class="st">"+"</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Data from months"</span>)</span>
<span id="cb11-6"><a href="#cb11-6"></a>    parser.add_argument(<span class="st">"--color"</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Taxi color"</span>, default<span class="op">=</span><span class="st">"green"</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a>    main_flow(args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Example, to run the flow for the months of January, February and March of 2021 for green taxis, we’ll run the following command:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">python</span> orchestration.py <span class="at">--years</span> 2021 <span class="at">--months</span> 1 2 3 <span class="at">--color</span> green</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Illustration of the flow of execution of the tasks in the flow.</p>
<pre><code>main_flow                       (Flow)
    |
    |---- download_and_read     (Subflow)
    |           |
    |           |---- fetch     (Task)
    |           |---- read_data (Task)
    |---- add_features          (Task)
    |---- train_best_model      (Task)</code></pre>
<p><img src="./images/intro_prefect/pipeline.png" class="img-fluid"></p>
<p>This will run the flow and log all the tasks in the Prefect UI.</p>
<p>Below you’ll find some screenshots of the Prefect UI, sample output on terminal, and MLflow UI.</p>
<p>Sample output on terminal:</p>
<p><img src="./images/intro_prefect/sample_output.png" class="img-fluid"></p>
<p>Prefect UI:</p>
<p>You can start the Prefect server using the command <code>prefect server start</code> and then navigate to <code>http://127.0.0.1:4200</code> to view the Prefect UI.</p>
<p><img src="./images/intro_prefect/prefect_ui.png" class="img-fluid"></p>
<p>You’ll find both the main flow and the subflow on the page as it records all the flows that are run. You can click on the flow to view the details of the flow. Main flow:</p>
<p><img src="./images/intro_prefect/main_flow.png" class="img-fluid"></p>
<p>Subflow:</p>
<p><img src="./images/intro_prefect/subflow.png" class="img-fluid"></p>
<p>Lastly you’ll find your experiment in the MLflow UI:</p>
<p>Run the mlflow UI using the command <code>mlflow server --backend-store-uri sqlite:///mlflow.db --host 0.0.0.0 --port 8080</code> and then navigate to <code>http://127.0.0.1:8080</code> to view the MLflow UI. Note: MLflow runs on port 5000 by default but we are running it on port 8080.</p>
<p><img src="./images/intro_prefect/mlflow_ui.png" class="img-fluid"></p>
<p>Congratulations on running your first Prefect flow! 🎉</p>
<p>You can find the whole code below:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>orchestration.py</strong></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="im">import</span> os</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="im">import</span> pickle</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="im">import</span> pathlib</span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="im">import</span> scipy</span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="im">import</span> mlflow</span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="im">import</span> sklearn</span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="im">import</span> argparse</span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="im">from</span> sklearn.feature_extraction <span class="im">import</span> DictVectorizer</span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="im">from</span> prefect.tasks <span class="im">import</span> task_input_hash</span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="im">from</span> datetime <span class="im">import</span> timedelta</span>
<span id="cb14-16"><a href="#cb14-16"></a></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Fetch Data"</span>, log_prints<span class="op">=</span><span class="va">True</span>, retries<span class="op">=</span><span class="dv">3</span>, cache_key_fn<span class="op">=</span>task_input_hash, cache_expiration<span class="op">=</span>timedelta(days<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="kw">def</span> fetch(year: <span class="bu">int</span>, month: <span class="bu">int</span>, color: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb14-19"><a href="#cb14-19"></a>    <span class="co">"""Fetches data from the NYC Taxi dataset and saves it locally"""</span></span>
<span id="cb14-20"><a href="#cb14-20"></a></span>
<span id="cb14-21"><a href="#cb14-21"></a>    <span class="co"># Download the data from the NYC Taxi dataset</span></span>
<span id="cb14-22"><a href="#cb14-22"></a></span>
<span id="cb14-23"><a href="#cb14-23"></a>    url <span class="op">=</span> <span class="ss">f"https://d37ci6vzurychx.cloudfront.net/trip-data/</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span></span>
<span id="cb14-24"><a href="#cb14-24"></a>    file_name <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span></span>
<span id="cb14-25"><a href="#cb14-25"></a></span>
<span id="cb14-26"><a href="#cb14-26"></a>    pathlib.Path(<span class="st">"data"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-27"><a href="#cb14-27"></a></span>
<span id="cb14-28"><a href="#cb14-28"></a>    os.system(<span class="ss">f"wget </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss"> -O ./data/</span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-29"><a href="#cb14-29"></a></span>
<span id="cb14-30"><a href="#cb14-30"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Read a Parquet file"</span>)</span>
<span id="cb14-31"><a href="#cb14-31"></a><span class="kw">def</span> read_data(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb14-32"><a href="#cb14-32"></a>    <span class="co">"""Read data into DataFrame"""</span></span>
<span id="cb14-33"><a href="#cb14-33"></a>    df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb14-34"><a href="#cb14-34"></a></span>
<span id="cb14-35"><a href="#cb14-35"></a>    df.lpep_dropoff_datetime <span class="op">=</span> pd.to_datetime(df.lpep_dropoff_datetime)</span>
<span id="cb14-36"><a href="#cb14-36"></a>    df.lpep_pickup_datetime <span class="op">=</span> pd.to_datetime(df.lpep_pickup_datetime)</span>
<span id="cb14-37"><a href="#cb14-37"></a></span>
<span id="cb14-38"><a href="#cb14-38"></a>    df[<span class="st">"duration"</span>] <span class="op">=</span> df.lpep_dropoff_datetime <span class="op">-</span> df.lpep_pickup_datetime</span>
<span id="cb14-39"><a href="#cb14-39"></a>    df.duration <span class="op">=</span> df.duration.<span class="bu">apply</span>(<span class="kw">lambda</span> td: td.total_seconds() <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb14-40"><a href="#cb14-40"></a></span>
<span id="cb14-41"><a href="#cb14-41"></a>    df <span class="op">=</span> df[(df.duration <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df.duration <span class="op">&lt;=</span> <span class="dv">60</span>)]</span>
<span id="cb14-42"><a href="#cb14-42"></a></span>
<span id="cb14-43"><a href="#cb14-43"></a>    categorical <span class="op">=</span> [<span class="st">"PULocationID"</span>, <span class="st">"DOLocationID"</span>]</span>
<span id="cb14-44"><a href="#cb14-44"></a>    df[categorical] <span class="op">=</span> df[categorical].astype(<span class="bu">str</span>)</span>
<span id="cb14-45"><a href="#cb14-45"></a></span>
<span id="cb14-46"><a href="#cb14-46"></a>    <span class="cf">return</span> df</span>
<span id="cb14-47"><a href="#cb14-47"></a></span>
<span id="cb14-48"><a href="#cb14-48"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Add Features"</span>)</span>
<span id="cb14-49"><a href="#cb14-49"></a><span class="kw">def</span> add_features(df_train: pd.DataFrame, df_val: pd.DataFrame) <span class="op">-&gt;</span> <span class="bu">tuple</span>([</span>
<span id="cb14-50"><a href="#cb14-50"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb14-51"><a href="#cb14-51"></a>        scipy.sparse._csr.csr_matrix,</span>
<span id="cb14-52"><a href="#cb14-52"></a>        np.ndarray,</span>
<span id="cb14-53"><a href="#cb14-53"></a>        np.ndarray,</span>
<span id="cb14-54"><a href="#cb14-54"></a>        sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb14-55"><a href="#cb14-55"></a>    ]):</span>
<span id="cb14-56"><a href="#cb14-56"></a>    <span class="co">"""Add features to the model"""</span></span>
<span id="cb14-57"><a href="#cb14-57"></a>    df_train[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_train[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_train[<span class="st">"DOLocationID"</span>]</span>
<span id="cb14-58"><a href="#cb14-58"></a>    df_val[<span class="st">"PU_DO"</span>] <span class="op">=</span> df_val[<span class="st">"PULocationID"</span>] <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> df_val[<span class="st">"DOLocationID"</span>]</span>
<span id="cb14-59"><a href="#cb14-59"></a></span>
<span id="cb14-60"><a href="#cb14-60"></a>    categorical <span class="op">=</span> [<span class="st">"PU_DO"</span>]  <span class="co">#'PULocationID', 'DOLocationID']</span></span>
<span id="cb14-61"><a href="#cb14-61"></a>    numerical <span class="op">=</span> [<span class="st">"trip_distance"</span>]</span>
<span id="cb14-62"><a href="#cb14-62"></a></span>
<span id="cb14-63"><a href="#cb14-63"></a>    dv <span class="op">=</span> DictVectorizer()</span>
<span id="cb14-64"><a href="#cb14-64"></a></span>
<span id="cb14-65"><a href="#cb14-65"></a>    train_dicts <span class="op">=</span> df_train[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb14-66"><a href="#cb14-66"></a>    X_train <span class="op">=</span> dv.fit_transform(train_dicts)</span>
<span id="cb14-67"><a href="#cb14-67"></a></span>
<span id="cb14-68"><a href="#cb14-68"></a>    val_dicts <span class="op">=</span> df_val[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">"records"</span>)</span>
<span id="cb14-69"><a href="#cb14-69"></a>    X_val <span class="op">=</span> dv.transform(val_dicts)</span>
<span id="cb14-70"><a href="#cb14-70"></a></span>
<span id="cb14-71"><a href="#cb14-71"></a>    y_train <span class="op">=</span> df_train[<span class="st">"duration"</span>].values</span>
<span id="cb14-72"><a href="#cb14-72"></a>    y_val <span class="op">=</span> df_val[<span class="st">"duration"</span>].values</span>
<span id="cb14-73"><a href="#cb14-73"></a>    <span class="cf">return</span> X_train, X_val, y_train, y_val, dv</span>
<span id="cb14-74"><a href="#cb14-74"></a></span>
<span id="cb14-75"><a href="#cb14-75"></a></span>
<span id="cb14-76"><a href="#cb14-76"></a><span class="at">@flow</span>(name<span class="op">=</span><span class="st">"Subflow - Download and Read Data"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-77"><a href="#cb14-77"></a><span class="kw">def</span> download_and_read(years: <span class="bu">list</span>, months: <span class="bu">list</span>, color: <span class="bu">str</span>):</span>
<span id="cb14-78"><a href="#cb14-78"></a>    <span class="co"># Download the data from the NYC Taxi dataset</span></span>
<span id="cb14-79"><a href="#cb14-79"></a>    <span class="cf">for</span> year <span class="kw">in</span> years:</span>
<span id="cb14-80"><a href="#cb14-80"></a>        <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb14-81"><a href="#cb14-81"></a>            <span class="bu">print</span>(<span class="ss">f"Download: Year-Month: </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb14-82"><a href="#cb14-82"></a>            fetch(year, month, color)</span>
<span id="cb14-83"><a href="#cb14-83"></a></span>
<span id="cb14-84"><a href="#cb14-84"></a>    <span class="co"># Read the data into a DataFrame</span></span>
<span id="cb14-85"><a href="#cb14-85"></a>    track_data <span class="op">=</span>[[], []]</span>
<span id="cb14-86"><a href="#cb14-86"></a>    df_train <span class="op">=</span> pd.DataFrame()</span>
<span id="cb14-87"><a href="#cb14-87"></a>    <span class="cf">for</span> month <span class="kw">in</span> months[:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb14-88"><a href="#cb14-88"></a>        <span class="bu">print</span>(<span class="ss">f"Read: Year-Month: </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss"> (</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb14-89"><a href="#cb14-89"></a>        df <span class="op">=</span> read_data(<span class="ss">f"./data/</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>month<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span>)</span>
<span id="cb14-90"><a href="#cb14-90"></a>        df_train <span class="op">=</span> pd.concat([df_train, df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-91"><a href="#cb14-91"></a>        track_data[<span class="dv">0</span>].append(month)</span>
<span id="cb14-92"><a href="#cb14-92"></a></span>
<span id="cb14-93"><a href="#cb14-93"></a>    <span class="bu">print</span>(<span class="ss">f"Read: Year-Month: </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>months[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:0&gt;2}</span><span class="ss"> (</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb14-94"><a href="#cb14-94"></a>    df_val <span class="op">=</span> read_data(<span class="ss">f"./data/</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">_tripdata_</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>months[<span class="op">-</span><span class="dv">1</span>]<span class="sc">:0&gt;2}</span><span class="ss">.parquet"</span>)</span>
<span id="cb14-95"><a href="#cb14-95"></a>    track_data[<span class="dv">1</span>].append(months[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb14-96"><a href="#cb14-96"></a></span>
<span id="cb14-97"><a href="#cb14-97"></a>    <span class="bu">print</span>(<span class="ss">f"Training data consists of months: </span><span class="sc">{</span>track_data[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-98"><a href="#cb14-98"></a>    <span class="bu">print</span>(<span class="ss">f"Validation data consists of months: </span><span class="sc">{</span>track_data[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-99"><a href="#cb14-99"></a></span>
<span id="cb14-100"><a href="#cb14-100"></a>    <span class="cf">return</span> df_train, df_val</span>
<span id="cb14-101"><a href="#cb14-101"></a></span>
<span id="cb14-102"><a href="#cb14-102"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"Train Model"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-103"><a href="#cb14-103"></a><span class="kw">def</span> train_best_model(</span>
<span id="cb14-104"><a href="#cb14-104"></a>    X_train: scipy.sparse._csr.csr_matrix,</span>
<span id="cb14-105"><a href="#cb14-105"></a>    X_val: scipy.sparse._csr.csr_matrix,</span>
<span id="cb14-106"><a href="#cb14-106"></a>    y_train: np.ndarray,</span>
<span id="cb14-107"><a href="#cb14-107"></a>    y_val: np.ndarray,</span>
<span id="cb14-108"><a href="#cb14-108"></a>    dv: sklearn.feature_extraction.DictVectorizer,</span>
<span id="cb14-109"><a href="#cb14-109"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb14-110"><a href="#cb14-110"></a>    <span class="co">"""train a model with best hyperparams and write everything out"""</span></span>
<span id="cb14-111"><a href="#cb14-111"></a></span>
<span id="cb14-112"><a href="#cb14-112"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb14-113"><a href="#cb14-113"></a>        train <span class="op">=</span> xgb.DMatrix(X_train, label<span class="op">=</span>y_train)</span>
<span id="cb14-114"><a href="#cb14-114"></a>        valid <span class="op">=</span> xgb.DMatrix(X_val, label<span class="op">=</span>y_val)</span>
<span id="cb14-115"><a href="#cb14-115"></a></span>
<span id="cb14-116"><a href="#cb14-116"></a>        best_params <span class="op">=</span> {</span>
<span id="cb14-117"><a href="#cb14-117"></a>            <span class="st">"learning_rate"</span>: <span class="fl">0.09585355369315604</span>,</span>
<span id="cb14-118"><a href="#cb14-118"></a>            <span class="st">"max_depth"</span>: <span class="dv">30</span>,</span>
<span id="cb14-119"><a href="#cb14-119"></a>            <span class="st">"min_child_weight"</span>: <span class="fl">1.060597050922164</span>,</span>
<span id="cb14-120"><a href="#cb14-120"></a>            <span class="st">"objective"</span>: <span class="st">"reg:linear"</span>,</span>
<span id="cb14-121"><a href="#cb14-121"></a>            <span class="st">"reg_alpha"</span>: <span class="fl">0.018060244040060163</span>,</span>
<span id="cb14-122"><a href="#cb14-122"></a>            <span class="st">"reg_lambda"</span>: <span class="fl">0.011658731377413597</span>,</span>
<span id="cb14-123"><a href="#cb14-123"></a>            <span class="st">"seed"</span>: <span class="dv">42</span>,</span>
<span id="cb14-124"><a href="#cb14-124"></a>        }</span>
<span id="cb14-125"><a href="#cb14-125"></a></span>
<span id="cb14-126"><a href="#cb14-126"></a>        mlflow.log_params(best_params)</span>
<span id="cb14-127"><a href="#cb14-127"></a></span>
<span id="cb14-128"><a href="#cb14-128"></a>        booster <span class="op">=</span> xgb.train(</span>
<span id="cb14-129"><a href="#cb14-129"></a>            params<span class="op">=</span>best_params,</span>
<span id="cb14-130"><a href="#cb14-130"></a>            dtrain<span class="op">=</span>train,</span>
<span id="cb14-131"><a href="#cb14-131"></a>            num_boost_round<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb14-132"><a href="#cb14-132"></a>            evals<span class="op">=</span>[(valid, <span class="st">"validation"</span>)],</span>
<span id="cb14-133"><a href="#cb14-133"></a>            early_stopping_rounds<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb14-134"><a href="#cb14-134"></a>        )</span>
<span id="cb14-135"><a href="#cb14-135"></a></span>
<span id="cb14-136"><a href="#cb14-136"></a>        y_pred <span class="op">=</span> booster.predict(valid)</span>
<span id="cb14-137"><a href="#cb14-137"></a>        rmse <span class="op">=</span> mean_squared_error(y_val, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-138"><a href="#cb14-138"></a>        mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb14-139"><a href="#cb14-139"></a></span>
<span id="cb14-140"><a href="#cb14-140"></a>        pathlib.Path(<span class="st">"models"</span>).mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-141"><a href="#cb14-141"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"models/preprocessor.b"</span>, <span class="st">"wb"</span>) <span class="im">as</span> f_out:</span>
<span id="cb14-142"><a href="#cb14-142"></a>            pickle.dump(dv, f_out)</span>
<span id="cb14-143"><a href="#cb14-143"></a>        mlflow.log_artifact(<span class="st">"models/preprocessor.b"</span>, artifact_path<span class="op">=</span><span class="st">"preprocessor"</span>)</span>
<span id="cb14-144"><a href="#cb14-144"></a></span>
<span id="cb14-145"><a href="#cb14-145"></a>        mlflow.xgboost.log_model(booster, artifact_path<span class="op">=</span><span class="st">"models_mlflow"</span>)</span>
<span id="cb14-146"><a href="#cb14-146"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb14-147"><a href="#cb14-147"></a></span>
<span id="cb14-148"><a href="#cb14-148"></a><span class="at">@flow</span>(name<span class="op">=</span><span class="st">"Main Flow"</span>)</span>
<span id="cb14-149"><a href="#cb14-149"></a><span class="kw">def</span> main_flow(params):</span>
<span id="cb14-150"><a href="#cb14-150"></a>    <span class="co">"""Main flow of the program"""</span></span>
<span id="cb14-151"><a href="#cb14-151"></a>    </span>
<span id="cb14-152"><a href="#cb14-152"></a>    <span class="co"># MLflow settings</span></span>
<span id="cb14-153"><a href="#cb14-153"></a>    mlflow.set_tracking_uri(<span class="st">"sqlite:///mlflow.db"</span>)</span>
<span id="cb14-154"><a href="#cb14-154"></a>    mlflow.set_experiment(<span class="st">"nyc-taxi-experiment"</span>)</span>
<span id="cb14-155"><a href="#cb14-155"></a></span>
<span id="cb14-156"><a href="#cb14-156"></a>    <span class="co"># Download and read data</span></span>
<span id="cb14-157"><a href="#cb14-157"></a>    df_train, df_val <span class="op">=</span> download_and_read(params.years, params.months, params.color)</span>
<span id="cb14-158"><a href="#cb14-158"></a></span>
<span id="cb14-159"><a href="#cb14-159"></a>    <span class="co"># Transform</span></span>
<span id="cb14-160"><a href="#cb14-160"></a>    X_train, X_val, y_train, y_val, dv <span class="op">=</span> add_features(df_train, df_val)</span>
<span id="cb14-161"><a href="#cb14-161"></a></span>
<span id="cb14-162"><a href="#cb14-162"></a>    <span class="co"># Train</span></span>
<span id="cb14-163"><a href="#cb14-163"></a>    train_best_model(X_train, X_val, y_train, y_val, dv)</span>
<span id="cb14-164"><a href="#cb14-164"></a></span>
<span id="cb14-165"><a href="#cb14-165"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb14-166"><a href="#cb14-166"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">'Ingest CSV data to Postgres'</span>)</span>
<span id="cb14-167"><a href="#cb14-167"></a></span>
<span id="cb14-168"><a href="#cb14-168"></a>    parser.add_argument(<span class="st">"--years"</span>, nargs<span class="op">=</span><span class="st">"+"</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Data from year"</span>)</span>
<span id="cb14-169"><a href="#cb14-169"></a>    parser.add_argument(<span class="st">"--months"</span>, nargs<span class="op">=</span><span class="st">"+"</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Data from months"</span>)</span>
<span id="cb14-170"><a href="#cb14-170"></a>    parser.add_argument(<span class="st">"--color"</span>, required<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Taxi color"</span>, default<span class="op">=</span><span class="st">"green"</span>)</span>
<span id="cb14-171"><a href="#cb14-171"></a></span>
<span id="cb14-172"><a href="#cb14-172"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb14-173"><a href="#cb14-173"></a></span>
<span id="cb14-174"><a href="#cb14-174"></a>    main_flow(args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further Reading</h2>
<ol type="1">
<li><a href="https://docs.prefect.io/2.10.12/concepts/flows/">Prefect Flows</a></li>
<li><a href="https://docs.prefect.io/2.10.12/concepts/tasks/">Prefect Tasks</a></li>
<li><a href="https://docs.prefect.io/2.10.12/tutorial/">Prefect Tutorials</a></li>
</ol>
<p>In the next post, we will see what are prefect blocks and how to use them to build a more complex flow. Also, how to deploy our flows to Prefect Cloud and run them on a schedule.</p>
<p>Thank you for reading and I hope you found this notebook helpful. Upvote if you liked it, comment if you loved it. Hope to see you guys in the next one. Peace!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("(?:http:|https:)\/\/(www\.)?sagarthacker\.com\/*|javascript\:void\(0\)");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<script src="https://giscus.app/client.js" data-repo="sagar118/sagarthacker" data-repo-id="R_kgDOIPm5_Q" data-category="General" data-category-id="DIC_kwDOIPm5_c4CXlxO" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" data-loading="lazy" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Made with <a href="https://quarto.org/">Quarto</a>, by Sagar Thacker. License: <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>