<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sagar Thacker – mlflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-17YZDMEKH1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-17YZDMEKH1', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Sagar Thacker</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/"><i class="bi bi-linkedin" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com"><i class="bi bi-envelope" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#video" id="toc-video" class="nav-link active" data-scroll-target="#video">2.1 Video</a></li>
  <li><a href="#video-1" id="toc-video-1" class="nav-link" data-scroll-target="#video-1">2.2 Video</a></li>
  <li><a href="#video-2" id="toc-video-2" class="nav-link" data-scroll-target="#video-2">2.3 Video</a></li>
  <li><a href="#video-3" id="toc-video-3" class="nav-link" data-scroll-target="#video-3">2.4 Video</a></li>
  <li><a href="#video-4" id="toc-video-4" class="nav-link" data-scroll-target="#video-4">2.5 Video</a></li>
  <li><a href="#video-5" id="toc-video-5" class="nav-link" data-scroll-target="#video-5">2.6 Video</a></li>
  <li><a href="#homework-2" id="toc-homework-2" class="nav-link" data-scroll-target="#homework-2">Homework 2</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="video" class="level3">
<h3 class="anchored" data-anchor-id="video">2.1 Video</h3>
<p>ML experimenet: The process of building an ML model Experiment run: Each trial in an ML experiment Run Artifact: Any file that is associated with an ML run Experiment metadata</p>
<p>What is experiment tracking? Experiment tracking is the process of keeping track of all the relevant information from an ML experiment, which includes: - Source code - Environment - Data - Model - Hyperparameters - Metrics …</p>
<p>Why is experiment tracking so important? In general, because of these 3 main reasons: - Reproducibility - Organization - Optimization</p>
<p>Trakcing Experiments in spreedsheets: Why is not enough? - Error Prone - No standard format - Visibility &amp; Collaboration</p>
<p>MLflow Definition: “An open source platform for the machine learning lifecyle”</p>
<p>In practice, it’s just a Python package that can be installed with pip, and it contains four main modules: - Tracking - Models - Model Registry - Projects</p>
<p>Tracking experiments with MLflow The Mlflow Tracking module allows you to organize your experiments into runs, and to keep track of: - Parameters: Hyperparameters / any other parameters that you think will have an effect on the metric of the model example: path to the training dataset, cause later you can change it. Hence it will be reflected into the run and can be tracked. Others, can be pre-processing techniques used. - Metrics: Any evaluation metric - Metadata: eg. tags - Artifacts: Any file, model trained, visualizations, datasets as well -&gt; but does scale very well. - Models: Save the model</p>
<p>Along with this information, MLflow automatically logs extra information about the run: - Source code - Version of the code (git commit) - Start and end time - Author</p>
<p>mlflow demo To launch the mlflow ui: <code>mlflow ui</code></p>
</section>
<section id="video-1" class="level3">
<h3 class="anchored" data-anchor-id="video-1">2.2 Video</h3>
<p>Check out the requirements.txt</p>
<p>mlflow ui –backend-store-uri sqlite:///mlflow.db</p>
<p>Create environment: conda create -p venv python=3.9 -y Activate: conda activate venv/ Install requirements.txt: pip install -r requirements.txt</p>
<pre><code>.
├── duration_prediction.ipynb
├── models
├── requirements.txt
└── venv</code></pre>
<p>Checkout the duration_predictions.ipybn file</p>
</section>
<section id="video-2" class="level3">
<h3 class="anchored" data-anchor-id="video-2">2.3 Video</h3>
</section>
<section id="video-3" class="level3">
<h3 class="anchored" data-anchor-id="video-3">2.4 Video</h3>
<p>Model Management: - Error prone - No versioning - No model lineage</p>
<p>directory name as -&gt; final_model, model_final_final, …</p>
<ol type="1">
<li>Log the model as artifact:</li>
</ol>
<pre><code>mlflow.log_artifact(local_path="models/lin_reg.bin", artifact_path="models_pickle")</code></pre>
<ol start="2" type="1">
<li>Log model using the method <code>log_model</code>:</li>
</ol>
<pre><code>mlflow.xgboost.log_model(model_as_ip, artifact_path="models_mlflow")
mlflow.&lt;framework&gt;.log_model(model_as_ip, artifact_path="models_mlflow")</code></pre>
<p>Now let’s save the pre-processing step as well</p>
<pre><code>with open("models/preprocessor.b", "wb") as handle:
    pickle.dump(dv, handle) # dv = dictvectorizer

mlfow.log_artifact("models/preprocessor.b", artifact_path="preprocessor")</code></pre>
</section>
<section id="video-4" class="level3">
<h3 class="anchored" data-anchor-id="video-4">2.5 Video</h3>
<p>Model Registry All the models that are ready for production should be stored in model registry. It helps in communication between the person building the model and the person that is in charge of deploying the model</p>
<p>Model registry has multiple stages: - Staging - Production - Archive</p>
<p>Data Scientist only decides what are the models that are ready for production, once the model is registered in the model registry the deployment engineer can take a look and check what are the parameters that were used, what is the size of the model, the performance, and based on that decide to move this model between the different stages.</p>
<p>Model registry is not deploying any model, it is only a place to list what are the models that are production-ready and the stages are just labels. Complement model registry with some CI/CD pipeline for deployment.</p>
<pre><code>from mlflow.tracking import MlflowClient

MLFLOW_TRACKING_URI = "sqlite:///mlflow.db"
clinet = MlflowClient(tracking_uri=MLFLOW_TRACKING_URI)

client.list_experiments()

client.create_experiment(name = "my-cool-experiment")

from mlflow.entities import ViewType

runs = client.search_runs (
    experiment_ids='1',
    filter_string='',
    run_view_type=ViewType.ACTIVE_ONLY,
    max_results=5,
    order_by=["metrics.rmse ASC"]
)</code></pre>
<p><strong>Promote some of the models to model registry</strong></p>
<pre><code>model_uri = f"runs:/{run_id}/model"
mlflow.register_model(model_uri=model_uri, name="nyc-taxi-regressor")

client.list_registered_models()

model_name = "nyc-taxi-regressor"
latest_versions = client.get_latest_versions(name=model_name)

model_version = 4
new_stage = "Staging"
client.transition_model_version_stage(
    name=model_name,
    version=model_version,
    stage=new_stage,
    archive_existing_versions=False
)

from datetime import datetime
date = datetime.today().date()
client.update_model_version(
    name=model_name,
    version=model_version,
    description = f"The model version {model_version} was transitioned to {new_stage} on {date}" 
)

from sklearn.metrics import mean_squared_error
import pandas as pd


def read_dataframe(filename):
    df = pd.read_csv(filename)

    df.lpep_dropoff_datetime = pd.to_datetime(df.lpep_dropoff_datetime)
    df.lpep_pickup_datetime = pd.to_datetime(df.lpep_pickup_datetime)

    df['duration'] = df.lpep_dropoff_datetime - df.lpep_pickup_datetime
    df.duration = df.duration.apply(lambda td: td.total_seconds() / 60)

    df = df[(df.duration &gt;= 1) &amp; (df.duration &lt;= 60)]

    categorical = ['PULocationID', 'DOLocationID']
    df[categorical] = df[categorical].astype(str)
    
    return df


def preprocess(df, dv):
    df['PU_DO'] = df['PULocationID'] + '_' + df['DOLocationID']
    categorical = ['PU_DO']
    numerical = ['trip_distance']
    train_dicts = df[categorical + numerical].to_dict(orient='records')
    return dv.transform(train_dicts)


def test_model(name, stage, X_test, y_test):
    model = mlflow.pyfunc.load_model(f"models:/{name}/{stage}")
    y_pred = model.predict(X_test)
    return {"rmse": mean_squared_error(y_test, y_pred, squared=False)}

df = read_dataframe("data/green_tripdata_2021-03.csv")

client.download_artifacts(run_id=run_id, path='preprocessor', dst_path='.')

import pickle

with open("preprocessor/preprocessor.b", "rb") as f_in:
    dv = pickle.load(f_in)

X_test = preprocess(df, dv)

target = "duration"
y_test = df[target].values

%time test_model(name=model_name, stage="Production", X_test=X_test, y_test=y_test)

%time test_model(name=model_name, stage="Staging", X_test=X_test, y_test=y_test)

client.transition_model_version_stage(
    name=model_name,
    version=4,
    stage="Production",
    archive_existing_versions=True
)</code></pre>
<p>Model management in MLflow The model registry component is a centralized model store, set of APIs, and a UI, to collaboratively manage the full lifecycle of an MLflow Model.</p>
<p>It provides: - Model lineage - Model versioning - Stage transitions, and - Annotations</p>
</section>
<section id="video-5" class="level3">
<h3 class="anchored" data-anchor-id="video-5">2.6 Video</h3>
<p>MLflow in Practice Let’s consider these three scenarios:</p>
<ul>
<li>A single data scientist participating in an ML competition
<ul>
<li>A remote tracking server will be a over-kill</li>
</ul></li>
<li>A cross-functional team with one data scientist working on an ML model
<ul>
<li>Sharing information is required but running a tracking server remotely is also not required. Locally is enough.</li>
<li>Model registry could be a good idea to manage the life cycle of the models but not clear whether to run it locally or remotely.</li>
</ul></li>
<li>Multiple data scientists working on multiple ML models
<ul>
<li>Sharing the information is very important.</li>
<li>Remote tracking is important.</li>
<li>Model registry is also important.</li>
</ul></li>
</ul>
<p>Configuring MLflow - Backend Store - local filesystem - SQLAlchemy compatible DB (eg. SQLite) - Artifacts Store - local filesystem - remote (eg. S3 bucket) - Tracking Server - No tracking server - local host - remote</p>
<p>Checkout the dirctory at: https://github.com/DataTalksClub/mlops-zoomcamp/tree/main/02-experiment-tracking/running-mlflow-examples</p>
<p>Remote tracking server: The tracking server can be easily deployed to the cloud. Some benefits: - Share experiments with other data scientists. - Collaborate with others to build and deploy models - Give more visibility of the data science efforts.</p>
<p>Issues with running a remote (shared) MLflow server</p>
<ul>
<li>Security
<ul>
<li>Restrict access to the server (eg. access through VPN)</li>
</ul></li>
<li>Scalability
<ul>
<li>Check Deploy MLflow on AWS Fargate</li>
<li>Check MLflow at Company Scale by Jean-Denis Lesage</li>
</ul></li>
<li>Isolation
<ul>
<li>Deine standard for naming experiments, models, and a set of default tags</li>
<li>Restrict access to artifact (eg. use S3 buckets living in different AWS accounts)</li>
</ul></li>
</ul>
<p>MLflow limitations (and when not to use it) - Authentication &amp; Users: The open source version of MLflow doesn’t provide any sort of authentication - Data versioning: to ensure full reproducibility we need to version the data used to train the model. MLflow doesn’t provide a built-in solution for that but there are a few ways to deal with this limitation. (log Params for data path) - Model/Data Monitoring &amp; Alerting: This is outside of the scope of Mlflow and currently there are more suitable tools for doing this.</p>
<p>Alternatives: - Neptune - Comet - Weights &amp; Biases</p>
</section>
<section id="homework-2" class="level3">
<h3 class="anchored" data-anchor-id="homework-2">Homework 2</h3>
<ol type="1">
<li>2.3.2</li>
<li>154 kb</li>
<li>max_depth = 10</li>
<li>mlflow server –backend-store-uri sqlite:///backend.db –default-artifact-root ./artifacts RMSE: 2.45</li>
<li>2.185 (I got 2.285)</li>
<li>Model version, Source Experiment, Model Signature -&gt; All of the above</li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/(?:http:|https:)\/\/(www\.)?sagarthacker\.com\/*|javascript\:void\(0\)/);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Made with <a href="https://quarto.org/">Quarto</a>, by Sagar Thacker. License: <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC BY-SA 2.0</a>.</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>