<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sagar Thacker">
<meta name="dcterms.date" content="2023-06-11">
<meta name="description" content="A comprehensive guide to deploying Prefect Flows">

<title>Sagar Thacker - Prefect Deployment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-17YZDMEKH1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-17YZDMEKH1', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Sagar Thacker</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/"><i class="bi bi-linkedin" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com"><i class="bi bi-envelope" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Prefect Deployment</h1>
                  <div>
        <div class="description">
          A comprehensive guide to deploying Prefect Flows
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">MLOps</div>
                <div class="quarto-category">Prefect</div>
                <div class="quarto-category">Deployment</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Sagar Thacker </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 11, 2023</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-does-deployment-mean" id="toc-what-does-deployment-mean" class="nav-link active" data-scroll-target="#what-does-deployment-mean">What does deployment mean?</a></li>
  <li><a href="#deployment-in-prefect" id="toc-deployment-in-prefect" class="nav-link" data-scroll-target="#deployment-in-prefect">Deployment in Prefect</a></li>
  <li><a href="#deployment-in-action" id="toc-deployment-in-action" class="nav-link" data-scroll-target="#deployment-in-action">Deployment in Action</a>
  <ul class="collapse">
  <li><a href="#step-1-start-a-prefect-server" id="toc-step-1-start-a-prefect-server" class="nav-link" data-scroll-target="#step-1-start-a-prefect-server">Step 1: Start a Prefect server</a></li>
  <li><a href="#step-2-create-a-yaml-file-for-the-deployment" id="toc-step-2-create-a-yaml-file-for-the-deployment" class="nav-link" data-scroll-target="#step-2-create-a-yaml-file-for-the-deployment">Step 2: Create a yaml file for the deployment</a></li>
  <li><a href="#work-queues" id="toc-work-queues" class="nav-link" data-scroll-target="#work-queues">Work Queues</a></li>
  <li><a href="#step-3-create-a-deployment-on-prefect-api" id="toc-step-3-create-a-deployment-on-prefect-api" class="nav-link" data-scroll-target="#step-3-create-a-deployment-on-prefect-api">Step 3: Create a deployment on Prefect API</a></li>
  <li><a href="#step-4-start-an-agent" id="toc-step-4-start-an-agent" class="nav-link" data-scroll-target="#step-4-start-an-agent">Step 4: Start an agent</a></li>
  <li><a href="#step-5-execute-the-deployment" id="toc-step-5-execute-the-deployment" class="nav-link" data-scroll-target="#step-5-execute-the-deployment">Step 5: Execute the deployment</a></li>
  </ul></li>
  <li><a href="#deployment.yaml-file" id="toc-deployment.yaml-file" class="nav-link" data-scroll-target="#deployment.yaml-file"><code>deployment.yaml</code> file</a></li>
  <li><a href="#schedules" id="toc-schedules" class="nav-link" data-scroll-target="#schedules">Schedules</a></li>
  <li><a href="#agents-and-workers" id="toc-agents-and-workers" class="nav-link" data-scroll-target="#agents-and-workers">Agents and Workers</a></li>
  <li><a href="#worker" id="toc-worker" class="nav-link" data-scroll-target="#worker">Worker</a></li>
  <li><a href="#scheduled-flow-run-example-with-worker" id="toc-scheduled-flow-run-example-with-worker" class="nav-link" data-scroll-target="#scheduled-flow-run-example-with-worker">Scheduled Flow Run Example with Worker</a>
  <ul class="collapse">
  <li><a href="#step-1-create-a-new-work-pool." id="toc-step-1-create-a-new-work-pool." class="nav-link" data-scroll-target="#step-1-create-a-new-work-pool.">Step 1: Create a new work-pool.</a></li>
  <li><a href="#step-2-create-a-new-yaml-file." id="toc-step-2-create-a-new-yaml-file." class="nav-link" data-scroll-target="#step-2-create-a-new-yaml-file.">Step 2: Create a new yaml file.</a></li>
  <li><a href="#step-3-apply-the-deployment." id="toc-step-3-apply-the-deployment." class="nav-link" data-scroll-target="#step-3-apply-the-deployment.">Step 3: Apply the deployment.</a></li>
  <li><a href="#step-4-start-the-worker." id="toc-step-4-start-the-worker." class="nav-link" data-scroll-target="#step-4-start-the-worker.">Step 4: Start the worker.</a></li>
  <li><a href="#step-5-execute-the-deployment." id="toc-step-5-execute-the-deployment." class="nav-link" data-scroll-target="#step-5-execute-the-deployment.">Step 5: Execute the deployment.</a></li>
  </ul></li>
  <li><a href="#storage" id="toc-storage" class="nav-link" data-scroll-target="#storage">Storage</a></li>
  <li><a href="#prefect-projects" id="toc-prefect-projects" class="nav-link" data-scroll-target="#prefect-projects">Prefect Projects</a>
  <ul class="collapse">
  <li><a href="#step-1-create-a-new-project." id="toc-step-1-create-a-new-project." class="nav-link" data-scroll-target="#step-1-create-a-new-project.">Step 1: Create a new project.</a></li>
  <li><a href="#step-2-create-a-flow." id="toc-step-2-create-a-flow." class="nav-link" data-scroll-target="#step-2-create-a-flow.">Step 2: Create a flow.</a></li>
  <li><a href="#step-3-start-the-prefect-server." id="toc-step-3-start-the-prefect-server." class="nav-link" data-scroll-target="#step-3-start-the-prefect-server.">Step 3: Start the Prefect Server.</a></li>
  <li><a href="#step-4-start-the-prefect-worker." id="toc-step-4-start-the-prefect-worker." class="nav-link" data-scroll-target="#step-4-start-the-prefect-worker.">Step 4: Start the Prefect Worker.</a></li>
  <li><a href="#step-5-configure-the-deployment.yaml-file." id="toc-step-5-configure-the-deployment.yaml-file." class="nav-link" data-scroll-target="#step-5-configure-the-deployment.yaml-file.">Step 5: Configure the deployment.yaml file.</a></li>
  <li><a href="#step-6-deploy-your-flow." id="toc-step-6-deploy-your-flow." class="nav-link" data-scroll-target="#step-6-deploy-your-flow.">Step 6: Deploy your flow.</a></li>
  <li><a href="#step-7-execute-the-deployments." id="toc-step-7-execute-the-deployments." class="nav-link" data-scroll-target="#step-7-execute-the-deployments.">Step 7: Execute the deployments.</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In this post, weâ€™ll be looking at how to deploy a Prefect flow locally.</p>
<section id="what-does-deployment-mean" class="level2">
<h2 class="anchored" data-anchor-id="what-does-deployment-mean">What does deployment mean?</h2>
<p>So far, weâ€™ve learned how to create and run a workflow on our local machine. The Prefect API has been helpful in tracking the workflowâ€™s status through the user interface.</p>
<p>However, what if we need to run the workflow on a different machine or schedule it to run automatically? This is where deployment comes into play.</p>
</section>
<section id="deployment-in-prefect" class="level2">
<h2 class="anchored" data-anchor-id="deployment-in-prefect">Deployment in Prefect</h2>
<p>To deploy a Prefect workflow, we need to package the workflow code, settings, and infrastructure configuration. This packaging process enables us to manage the workflow using the Prefect API and execute it remotely on a Prefect agent.</p>
<p>I understand this might sound technical, so letâ€™s simplify it further.</p>
<ul>
<li>Deployment can be thought of as shipping a package that includes the workflow code, settings, and infrastructure configuration required by Prefect to run the workflow.</li>
<li>All the necessary files are packed into a single box and labeled with a yaml file e.g.&nbsp;<code>deployment.yaml</code>. This file contains information about the workflow, its location, and additional metadata.</li>
<li>Using the deployment.yaml file, we can ship the package to the Prefect API, which creates a deployment object and stores it in the Prefect database. The deployment is now ready to be executed.</li>
<li>However, simply deploying the workflow doesnâ€™t start its execution.</li>
<li>In Prefect, we have the concept of <code>work-pools</code> and <code>agents/workers</code>. When a deployed workflow runs, it creates a <code>flow run</code> which is similar to what we did previously when running a Prefect flow.</li>
<li>However, during deployment, the flow run is submitted to a specific work-pool for scheduling. Think of the work-pool as a staging area where the flow run waits to be picked up by an agent/worker. (Imagine package lying in the warehouse waiting for the courier to be picked).</li>
<li>An agent or worker (courier), operating within the execution environment, polls the work-pool for new runs to execute.</li>
<li>Once an agent/worker picks up a flow run, it proceeds to execute it and reports the status back to the Prefect API.</li>
</ul>
<p>It might seem like a lot of steps, but itâ€™s quite simple once you get the hang of it. Weâ€™ll be going through each step in detail in the next section.</p>
</section>
<section id="deployment-in-action" class="level2">
<h2 class="anchored" data-anchor-id="deployment-in-action">Deployment in Action</h2>
<p>To demonstrate deployment, weâ€™ll be using a simple prefect flow that has a flow with one task. The task simply prints a message to the console. You can find the code for the flow below.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>"prefect_demo.py</strong></pre>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"say_hello"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">def</span> say_hello():</span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="bu">print</span>(<span class="st">"Hello, I'm a Task!"</span>)</span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="at">@flow</span>(name<span class="op">=</span><span class="st">"hello-flow"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">def</span> flow_hello():</span>
<span id="cb1-9"><a href="#cb1-9"></a>    <span class="bu">print</span>(<span class="st">"Hello, I'm a Flow!"</span>)</span>
<span id="cb1-10"><a href="#cb1-10"></a>    <span class="bu">print</span>(<span class="st">"I'm about to call a Task..."</span>)</span>
<span id="cb1-11"><a href="#cb1-11"></a>    say_hello()</span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-14"><a href="#cb1-14"></a>    flow_hello()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The flow is simple and will help us focus more on the deployment process rather than understanding what the flow does. Letâ€™s get started.</p>
<section id="step-1-start-a-prefect-server" class="level3">
<h3 class="anchored" data-anchor-id="step-1-start-a-prefect-server">Step 1: Start a Prefect server</h3>
<p>Before we can deploy our flow, we need to start a Prefect server. Weâ€™ll be using the Prefect CLI command to start the server. Run the following command in your terminal.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">prefect</span> server start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-create-a-yaml-file-for-the-deployment" class="level3">
<h3 class="anchored" data-anchor-id="step-2-create-a-yaml-file-for-the-deployment">Step 2: Create a yaml file for the deployment</h3>
<p>Weâ€™ll use the <code>prefect deployment build</code> command to create a deployment definition yaml file. Run the Prefect CLI command from the folder containing your flow script and any dependencies of the script.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">prefect</span> deployment build [OPTIONS] PATH</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Path to the flow is specified in the format <code>path-to-script:flow-function-name</code> â€” The path and filename of the flow script file, a colon, then the name of the <strong>entrypoint</strong> flow function.</p>
<p>For our example, the command will be:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">prefect</span> deployment build <span class="at">-n</span> flow_test <span class="at">-p</span> default-agent-pool <span class="at">-q</span> test prefect_demo.py:flow_hello</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Letâ€™s break down the command:</p>
<ul>
<li><code>-n</code> specifies the name of the deployment. Weâ€™ve named our deployment <code>flow_test</code>.</li>
<li><code>-p</code> specifies the name of the work-pool. Prefect provides a default work-pool named <code>default-agent-pool</code>.</li>
<li><code>-q</code> specifies the name of the work queue. Weâ€™ve named our queue <code>test</code>.</li>
<li><code>prefect_demo.py:flow_hello</code> specifies the path to the flow script, a colon, then the name of the flow function.</li>
</ul>
<p>When you run this command, Prefect:</p>
<ul>
<li>Creates a flow_hello-deployment.yaml file for your deployment based on your flow code and options. Usually the format is <code>&lt;flow_name&gt;-deployment.yaml</code>. You can specify a different name using the <code>--output</code> option.</li>
<li>Uploads your flow files to the configured storage location (local by default). (Weâ€™ll cover storage in a later post).</li>
<li>Submit your deployment to the work queue test. The work queue test will be created if it doesnâ€™t exist.</li>
</ul>
<p>You can find the yaml file in the same folder as your flow script.</p>
</section>
<section id="work-queues" class="level3">
<h3 class="anchored" data-anchor-id="work-queues">Work Queues</h3>
<hr>
<p>Imagine work-pool has a big highway and work-queues are lanes on the highway. Each work-queue is a separate lane on the highway. When a flow run is submitted to a work-pool, it is placed in a work-queue.</p>
<p>As different lanes in a highway have different priorities, and purpose so do work-queues. For example, you might have a work-queue for high priority flows and another for low priority flows. You can seperate your test and production flows by using different work-queues.</p>
<p>Below youâ€™ll find a brief overview of work-queues and I highly recommend you read the <a href="https://docs.prefect.io/2.10.13/concepts/work-pools/#work-queues">official documentation</a></p>
<ul>
<li>Work pools have a <code>default</code> queue where all work is sent by default, but additional queues can be added for finer control over work delivery.</li>
<li>Work queues have priorities indicated by unique positive integers, with lower numbers having higher priority. New queues can be added without affecting the priority of existing queues.</li>
<li>Work queues can also have their own concurrency limits, allowing for precise control over the execution of work. However, all queues are subject to the global work pool concurrency limit.</li>
</ul>
</section>
<section id="step-3-create-a-deployment-on-prefect-api" class="level3">
<h3 class="anchored" data-anchor-id="step-3-create-a-deployment-on-prefect-api">Step 3: Create a deployment on Prefect API</h3>
<p>Now that we have the deployment.yaml file, we can create a deployment on the Prefect API. To do this, weâ€™ll use the <code>prefect deployment apply</code> Prefect CLI command.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">prefect</span> deployment apply PATH_TO_YAML_FILE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For our example, the command will be:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">prefect</span> deployment apply flow_hello-deployment.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the deployment is created, youâ€™ll see it in the CLI and the Prefect UI. Run the <code>prefect deployment ls</code> command to see a list of all deployments.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">prefect</span> deployment ls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="./images/prefect-deployment/cli-deploy.png" class="img-fluid"></p>
<p><img src="./images/prefect-deployment/ui-deploy.png" class="img-fluid"></p>
<p>To view the work-pool and work-queue in the Prefect UI, navigate to the <code>Work Pools</code> section and click on the <code>default-agent-pool</code> work-pool. Click on the <code>Work Queues</code> tab to view the <code>test</code> work-queue. Youâ€™ll also notice a <code>default</code> work queue. This is the default work queue that Prefect creates when you create any work-pool.</p>
<p><img src="./images/prefect-deployment/ui-work-queue.png" class="img-fluid"></p>
</section>
<section id="step-4-start-an-agent" class="level3">
<h3 class="anchored" data-anchor-id="step-4-start-an-agent">Step 4: Start an agent</h3>
<p>Agent processes are lightweight polling services that regularly check a work-pool for scheduled work and execute the corresponding flow runs.</p>
<p>By default, agents poll for work every 15 seconds. You can adjust this interval by configuring the <code>PREFECT_AGENT_QUERY_INTERVAL</code> setting in the <a href="https://docs.prefect.io/concepts/settings/">profile settings</a>.</p>
<p>You can have multiple agent processes running for a single work pool. Each agent process sends a unique ID to the server, which helps distinguish them from one another and informs users about the number of active agents.</p>
<p>Weâ€™ll use the <code>prefect agent start</code> command to start an agent.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">prefect</span> agent start <span class="at">-p</span> [WORK_POOL_NAME]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For our example, the command will be:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">prefect</span> agent start <span class="at">-p</span> default-agent-pool</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-5-execute-the-deployment" class="level3">
<h3 class="anchored" data-anchor-id="step-5-execute-the-deployment">Step 5: Execute the deployment</h3>
<p>Now that we have an agent running, we can execute the deployment. To do this, weâ€™ll use the <code>prefect deployment run</code> command.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">prefect</span> deployment run [OPTIONS] DEPLOYMENT_NAME</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you donâ€™t know the name of the deployment, you can use the <code>prefect deployment ls</code> command to get a list of all deployments.</p>
<p>For our example, the command will be:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">prefect</span> deployment run hello-flow/flow_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After running the command, youâ€™ll see the flow run in the Prefect UI. Navigate to the <code>Flow Runs</code> section to view the flow run. Click on the flow run to view the logs.</p>
<p><img src="./images/prefect-deployment/ui-flow-run.png" class="img-fluid"></p>
<p>You can also run the flow from the Prefect UI from the <code>Flow</code> section.</p>
<p><img src="./images/prefect-deployment/ui-quick-run.png" class="img-fluid"></p>
<p>Congratulations! Youâ€™ve successfully deployed and executed your first Prefect flow. Yet thereâ€™s so much more to cover like schedules, storage, agents, workers, and more.</p>
<p>Congratulations! ðŸŽ‰ Youâ€™ve successfully deployed and executed your first Prefect flow. Yet thereâ€™s so much more to cover like ðŸ“… schedules, ðŸ“¦ storage, ðŸ’ª agents, workers, and more.</p>
</section>
</section>
<section id="deployment.yaml-file" class="level2">
<h2 class="anchored" data-anchor-id="deployment.yaml-file"><code>deployment.yaml</code> file</h2>
<p>The YAML file for a deployment contains extra settings required to create the deployment on the server.</p>
<p>A single flow can have multiple deployments created for it, each with different schedules, tags, and other configurations.</p>
<p>To achieve this, you can have multiple deployment YAML files referencing the same flow definition, each specifying distinct settings. The only rule is that each deployment must have a unique name.</p>
<p><img src="./images/prefect-deployment/deployment-flow.png" class="img-fluid"></p>
<p>Each deployment is linked to a specific flow, but a flow can be referenced by multiple deployments.</p>
<p>Deployments are uniquely identified based on the combination of the flow name and deployment name.</p>
<p>This allows you to execute a single flow with various parameters, on multiple schedules, and in different environments. It also enables you to run different versions of the same flow for testing or production purposes.</p>
</section>
<section id="schedules" class="level2">
<h2 class="anchored" data-anchor-id="schedules">Schedules</h2>
<p>Schedules allow you to instruct the Prefect API to automatically generate new flow runs for you at regular intervals.</p>
<p>You can attach a schedule to any flow deployment. The Prefect Scheduler service regularly checks each deployment and generates new flow runs based on the schedule defined for that deployment.</p>
<p>There are four recommended ways to create a schedule for a deployment:</p>
<ul>
<li>Use the Prefect UI</li>
<li>Use the cron, interval, or rrule flags with the CLI deployment build command</li>
<li>Use the schedule parameter with a Python deployment file</li>
<li>Manually edit the deployment YAML fileâ€™s schedule section</li>
</ul>
<p>Prefect offers different types of schedules that cater to various needs and provide a high level of customization:</p>
<ol type="1">
<li><strong>Cron</strong>: This type is well-suited for users who have prior experience with cron and want to leverage its functionality.</li>
<li><strong>Interval</strong>: Ideal for deployments that require a consistent cadence of execution, irrespective of specific timestamps.</li>
<li><strong>RRule</strong>: Designed for deployments that rely on calendar-based logic, allowing for simple recurring schedules, irregular intervals, exclusions, or adjustments based on specific days of the month.</li>
</ol>
<p>These schedule types offer flexibility and can accommodate a wide range of scheduling requirements.</p>
<p>Weâ€™ll go through an example of scheduling a flow run in the <a href="#scheduled-flow-run-example-with-worker">section</a> below.</p>
</section>
<section id="agents-and-workers" class="level2">
<h2 class="anchored" data-anchor-id="agents-and-workers">Agents and Workers</h2>
<p>Work-pools serve as a way to organize work that agents or workers pick up for execution. The coordination between deployments and agents happens through a shared work-pool name.</p>
<p>In case you want to create a new work pool, you would have to choose the <code>type</code> of the work pool. <code>Type</code> defines the type of infrastructure that can execute runs from this work pool.</p>
<p>Thatâ€™s where which polling service (<code>Agent</code> / <code>Worker</code>) is decided. View the table below to understand the difference between the two.</p>
<table class="table">
<colgroup>
<col style="width: 35%">
<col style="width: 15%">
<col style="width: 49%">
</colgroup>
<thead>
<tr class="header">
<th>Work-Pool Type</th>
<th>Agent/Worker</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Amazon Elastic Container Service</td>
<td>Worker</td>
<td>Executes flow runs as ECS tasks</td>
</tr>
<tr class="even">
<td>Azure Container Service</td>
<td>Worker</td>
<td>Executes flow runs in ACI containers</td>
</tr>
<tr class="odd">
<td>Google Cloud Run</td>
<td>Worker</td>
<td>Executes flow runs as Google Cloud Run jobs</td>
</tr>
<tr class="even">
<td>Docker</td>
<td>Worker</td>
<td>Executes flow runs within Docker containers</td>
</tr>
<tr class="odd">
<td>Kubernetes</td>
<td>Worker</td>
<td>Executes flow runs as Kubernetes jobs</td>
</tr>
<tr class="even">
<td>Process</td>
<td>Worker</td>
<td>Executes flow runs in subprocesses</td>
</tr>
<tr class="odd">
<td>Prefect Agent</td>
<td>Agent</td>
<td>Executes flow runs in subprocesses</td>
</tr>
</tbody>
</table>
<p>We have seen an example of an agent in the previous <a href="#step-4-start-an-agent">section</a>. Letâ€™s look at an example of a worker.</p>
</section>
<section id="worker" class="level2">
<h2 class="anchored" data-anchor-id="worker">Worker</h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Workers are a beta feature and are subject to change in future releases.</p>
</div>
</div>
<p>Workers are similar to Agents in that they are long-running processes that poll for work i.e., fetch scheduled runs from a work pool and carry out their execution.</p>
<p>However, workers provide the advantage of more control over infrastructure configuration and the capability to route work to specific types of execution environments.</p>
<p>Each worker is assigned a type that corresponds to the specific execution environment where it will submit flow runs. Workers can only join work pools that match their designated type. Consequently, when deployments are associated with a work pool, you can determine the execution environment in which scheduled flow runs for that deployment will be executed.</p>
<p>Above table shows the different types of workers available. Prefect also provides a way to create your own <a href="https://docs.prefect.io/guides/deployment/developing-a-new-worker-type/">worker type</a>.</p>
</section>
<section id="scheduled-flow-run-example-with-worker" class="level2">
<h2 class="anchored" data-anchor-id="scheduled-flow-run-example-with-worker">Scheduled Flow Run Example with Worker</h2>
<section id="step-1-create-a-new-work-pool." class="level3">
<h3 class="anchored" data-anchor-id="step-1-create-a-new-work-pool.">Step 1: Create a new work-pool.</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">prefect</span> work-pool create [OPTIONS] NAME</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For our example, the command will be:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">prefect</span> work-pool create test-pool <span class="at">-t</span> process</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>-t</code> or <code>--type</code> flag is used to specify the type of work-pool. In our case, we are using the <code>process</code> type.</li>
</ul>
<p>On CLI you can use the command <code>prefect work-pool ls</code> to list all the work-pools.</p>
<p><img src="./images/prefect-deployment/cli-schedule-deploy.png" class="img-fluid"></p>
<p><img src="./images/prefect-deployment/ui-work-pool.png" class="img-fluid"></p>
</section>
<section id="step-2-create-a-new-yaml-file." class="level3">
<h3 class="anchored" data-anchor-id="step-2-create-a-new-yaml-file.">Step 2: Create a new yaml file.</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="ex">prefect</span> deployment build <span class="at">-n</span> demo_schedule <span class="at">-p</span> test-pool <span class="at">-q</span> demo <span class="at">--cron</span> <span class="st">"0 0 * * *"</span> <span class="at">--output</span> demo_schedule.yaml prefect_demo.py:flow_hello</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>--cron</code> flag is used to specify the cron schedule.</li>
</ul>
<p>This create flow runs for this deployment every day at midnight.</p>
</section>
<section id="step-3-apply-the-deployment." class="level3">
<h3 class="anchored" data-anchor-id="step-3-apply-the-deployment.">Step 3: Apply the deployment.</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">prefect</span> deployment apply demo_schedule.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="./images/prefect-deployment/ui-schedule-deploy.png" class="img-fluid"></p>
<p><img src="./images/prefect-deployment/ui-schedule-deploy-2.png" class="img-fluid"></p>
</section>
<section id="step-4-start-the-worker." class="level3">
<h3 class="anchored" data-anchor-id="step-4-start-the-worker.">Step 4: Start the worker.</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a><span class="ex">prefect</span> worker start <span class="at">-p</span> test-pool</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-5-execute-the-deployment." class="level3">
<h3 class="anchored" data-anchor-id="step-5-execute-the-deployment.">Step 5: Execute the deployment.</h3>
<p>Either run the deployment from the Prefect UI or use the CLI command.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>One observation you might have made is that we are using the same flow for both the deployments but with different deployments. This is because we want to run the first flow manually through CLI or UI and second on a schedule.</p>
</div>
</div>
<p>First can be used to test the flow and second can be used to run the flow on a schedule. It completely depends on your use case.</p>
<p>I hope this provides a comprehensive overview of Prefect deployment and steps to deploy a flow. Hushâ€¦ thereâ€™s an abundance yet to explore.</p>
</section>
</section>
<section id="storage" class="level2">
<h2 class="anchored" data-anchor-id="storage">Storage</h2>
<p>Prefect follows a hybrid model where your flow code stays within your storage and execution infrastructure and never lives on the Prefect server or database. What does that mean?</p>
<p>It means that thereâ€™s always a boundary between your code, your private infrastructure, and the Prefect backend. You can use your existing storage infrastructure to store your flow code. Prefect supports a wide range of storage options like GitHub, local storage, Bitbucket, Amazon S3, Google Cloud Storage, Azure Storage, and more.</p>
<p>Till now we have been using local storage to store our flow code and run the Prefect Server. However, you might choose to store the flow code in a GitHub repository and run the Prefect Server on your local machine. Prefect supports this as well.</p>
<p><img src="./images/prefect-deployment/deployment-flow-storage.png" class="img-fluid"></p>
<p>While creating a deployment, you can specify the storage location of your flow code. This letâ€™s Prefect Agent/Worker know where to look for the flow code.</p>
<p>One cool thing about it is if you make changes to your flow code, you donâ€™t have to create a new deployment. Prefect Agent/Worker will automatically pick up the changes and execute the flow with the new code.</p>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>However, changes to the infrastructure code will require a new deployment. Such as entrypoint. This part of changing the infrastructure code is experimental for me, I have to try it out more to better understand it.</p>
</div>
</div>
<p>This post has been a long one. Hence, I have not covered storage in detail. You can refer to the official <a href="https://docs.prefect.io/2.10.13/concepts/storage/">Prefect documentation</a> on this topic for more details. Hopefully, in the next post I will cover the remaining topics.</p>
<p>Wait, there is <code>ONE</code> more thing!</p>
</section>
<section id="prefect-projects" class="level2">
<h2 class="anchored" data-anchor-id="prefect-projects">Prefect Projects</h2>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Projects are a beta feature and are subject to change in future releases.</p>
</div>
</div>
<p>Prefect Projects is a new feature that describe how to prepare one or more flow deployments. You can create a project using the Prefect CLI command <code>prefect project init</code>.</p>
<p>I would encourage you to follow along in a new directory so as to seperate what we did so far from the project.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># Create a new directory</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">mkdir</span> project</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co"># Change directory</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="bu">cd</span> project</span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co"># Create a new Prefect project</span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="ex">prefect</span> project init</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once you run the command, three files and a directory will be created - <code>deployment.yaml</code>, <code>prefect.yaml</code>, <code>.prefectignore</code>, and <code>.prefect/</code> directory.</p>
<ul>
<li><code>deployment.yaml</code>: a YAML file describing base settings for deployments produced from this project</li>
<li><code>prefect.yaml</code>: a YAML file describing procedural steps for preparing a deployment from this project, as well as instructions for preparing the execution environment for a deployment run</li>
<li><code>.prefect/</code>: a hidden directory where Prefect will store workflow metadata</li>
<li><code>.prefectignore</code>: a file that specifies files and directories to ignore when preparing a deployment</li>
</ul>
<p>Below weâ€™ll go through an example of how to use Prefect Projects to create a deployment.</p>
<p><img src="./images/prefect-deployment/flow-deployment-end-to-end.png" class="img-fluid"></p>
<section id="step-1-create-a-new-project." class="level3">
<h3 class="anchored" data-anchor-id="step-1-create-a-new-project.">Step 1: Create a new project.</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">prefect</span> project init</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-create-a-flow." class="level3">
<h3 class="anchored" data-anchor-id="step-2-create-a-flow.">Step 2: Create a flow.</h3>
<p>Weâ€™ll be utilizing the same flow we created earlier but with some changes. The flow will take a name as an argument, which are called <code>parameters</code> to a flow in Prefect.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>prefect_demo.py</strong></pre>
</div>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="im">import</span> argparse</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="im">from</span> prefect <span class="im">import</span> flow, task</span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="at">@task</span>(name<span class="op">=</span><span class="st">"say_hello"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="kw">def</span> say_hello():</span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="bu">print</span>(<span class="st">"Hello, I'm a Task!"</span>)</span>
<span id="cb19-7"><a href="#cb19-7"></a></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="at">@flow</span>(name<span class="op">=</span><span class="st">"hello-flow"</span>, log_prints<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="kw">def</span> flow_hello(name: <span class="bu">str</span>):</span>
<span id="cb19-10"><a href="#cb19-10"></a>    <span class="bu">print</span>(<span class="ss">f"Hello </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">, I'm a Flow!"</span>)</span>
<span id="cb19-11"><a href="#cb19-11"></a>    <span class="bu">print</span>(<span class="st">"I'm about to call a Task..."</span>)</span>
<span id="cb19-12"><a href="#cb19-12"></a>    say_hello()</span>
<span id="cb19-13"><a href="#cb19-13"></a></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb19-15"><a href="#cb19-15"></a>    parser <span class="op">=</span> argparse.ArgumentParser()</span>
<span id="cb19-16"><a href="#cb19-16"></a>    parser.add_argument(<span class="st">"--name"</span>, <span class="bu">help</span><span class="op">=</span><span class="st">"Your name"</span>, default<span class="op">=</span><span class="st">"World"</span>)</span>
<span id="cb19-17"><a href="#cb19-17"></a>    args <span class="op">=</span> parser.parse_args()    </span>
<span id="cb19-18"><a href="#cb19-18"></a>    </span>
<span id="cb19-19"><a href="#cb19-19"></a>    flow_hello(args.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3-start-the-prefect-server." class="level3">
<h3 class="anchored" data-anchor-id="step-3-start-the-prefect-server.">Step 3: Start the Prefect Server.</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="ex">prefect</span> server start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-4-start-the-prefect-worker." class="level3">
<h3 class="anchored" data-anchor-id="step-4-start-the-prefect-worker.">Step 4: Start the Prefect Worker.</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="ex">prefect</span> worker start <span class="at">-p</span> test-pool</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-5-configure-the-deployment.yaml-file." class="level3">
<h3 class="anchored" data-anchor-id="step-5-configure-the-deployment.yaml-file.">Step 5: Configure the deployment.yaml file.</h3>
<p>Previously, we created seperated files for creating a deployment and executing it.</p>
<p>However, with Prefect Projects, we can do both in a single file. The deployment.yaml file is used to configure the deployment. Letâ€™s look at the contents of the file.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deployment.yaml</strong></pre>
</div>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">deployments</span><span class="kw">:</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="kw">-</span><span class="co"> # base metadata</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> manual-deployment</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="at">  </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"test"</span><span class="kw">]</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">"Trigger deployment using `run` CLI command or Prefect UI"</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="at">  </span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co">  # flow-specific fields</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="at">  </span><span class="fu">entrypoint</span><span class="kw">:</span><span class="at"> prefect_demo.py:flow_hello</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="at">  </span><span class="fu">parameters</span><span class="kw">:</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">"Sagar"</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="at">  </span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="co">  # infra-specific fields</span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="at">  </span><span class="fu">work_pool</span><span class="kw">:</span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> test-pool</span></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="at">    </span><span class="fu">work_queue_name</span><span class="kw">:</span><span class="at"> demo</span></span>
<span id="cb22-16"><a href="#cb22-16"></a></span>
<span id="cb22-17"><a href="#cb22-17"></a><span class="kw">-</span><span class="co"> # base metadata</span></span>
<span id="cb22-18"><a href="#cb22-18"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> scheduled-deployment</span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="at">  </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">"dev"</span><span class="kw">]</span></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">"Trigger deployment using a Schedule"</span></span>
<span id="cb22-21"><a href="#cb22-21"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="at">    </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> 0 0 * * *</span></span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="at">    </span><span class="fu">timezone</span><span class="kw">:</span><span class="at"> America/Chicago</span></span>
<span id="cb22-24"><a href="#cb22-24"></a><span class="at">  </span></span>
<span id="cb22-25"><a href="#cb22-25"></a><span class="co">  # flow-specific fields</span></span>
<span id="cb22-26"><a href="#cb22-26"></a><span class="at">  </span><span class="fu">entrypoint</span><span class="kw">:</span><span class="at"> prefect_demo.py:flow_hello</span></span>
<span id="cb22-27"><a href="#cb22-27"></a><span class="at">  </span><span class="fu">parameters</span><span class="kw">:</span></span>
<span id="cb22-28"><a href="#cb22-28"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">"World"</span></span>
<span id="cb22-29"><a href="#cb22-29"></a><span class="at">  </span></span>
<span id="cb22-30"><a href="#cb22-30"></a><span class="co">  # infra-specific fields</span></span>
<span id="cb22-31"><a href="#cb22-31"></a><span class="at">  </span><span class="fu">work_pool</span><span class="kw">:</span></span>
<span id="cb22-32"><a href="#cb22-32"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> test-pool</span></span>
<span id="cb22-33"><a href="#cb22-33"></a><span class="at">    </span><span class="fu">work_queue_name</span><span class="kw">:</span><span class="at"> demo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-6-deploy-your-flow." class="level3">
<h3 class="anchored" data-anchor-id="step-6-deploy-your-flow.">Step 6: Deploy your flow.</h3>
<p>This file has two deployment declarations, each referencing a same flow in the project but with different parameters and schedule. Each deployment declaration has a unique name field and can be deployed individually by using the <code>--name</code> flag when deploying.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You also have the freedom to deploy different flows in the same yaml file. Example, we already have one flow file called <code>prefect_demo.py</code>. We can create another flow file called <code>prefect_demo_2.py</code> and reference it in the deployment.yaml file. Give the appropriate entrypoint and parameters and you are good to go.</p>
</div>
</div>
<p>This method of declaring multiple deployments allows the configuration for all deployments within a project to be version controlled and deployed with a single command.</p>
<p>You can deploy a single deployment by using the <code>--name</code> flag.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="ex">prefect</span> deploy <span class="at">--name</span> manual-deployment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can also deploy multiple deployments by providing multiple <code>--name</code> flags.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a><span class="ex">prefect</span> deploy <span class="at">--name</span> manual-deployment <span class="at">--name</span> scheduled-deployment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or, you can deploy all the deployments by using the <code>--all</code> flag.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="ex">prefect</span> deploy <span class="at">--all</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For our example, weâ€™ll deploy both the deployments.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a><span class="ex">prefect</span> deploy <span class="at">--all</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You might have noticed that we are using the <code>prefect deploy</code> command instead of <code>prefect deployment</code> command. This is because while using Prefect Projects, <code>prefect deploy</code> command under the hood performs multiple steps like build, push, pull, and applies the deployment. You can read more about it <a href="https://docs.prefect.io/2.10.13/concepts/projects/#deployment-mechanics">here</a>.</p>
<p><img src="./images/prefect-deployment/cli-project-deploy.png" class="img-fluid"></p>
<p><img src="./images/prefect-deployment/ui-project-deploy.png" class="img-fluid"></p>
</section>
<section id="step-7-execute-the-deployments." class="level3">
<h3 class="anchored" data-anchor-id="step-7-execute-the-deployments.">Step 7: Execute the deployments.</h3>
<p>You can execute a deployment either through the Prefect UI or using the CLI command.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Using the default parameters</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="ex">prefect</span> deployment run hello-flow/manual-deployment</span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co"># Using the custom parameters</span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="ex">prefect</span> deployment run hello-flow/manual-deployment <span class="at">--param</span> name=<span class="st">"Prefect"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output of the CLI command with default parameters.</p>
<p><img src="./images/prefect-deployment/ui-project-run.png" class="img-fluid"></p>
<p>Output of the CLI command with custom parameters.</p>
<p><img src="./images/prefect-deployment/ui-project-run-custom.png" class="img-fluid"></p>
<p>Congratulations! ðŸŽ‰ You have successfully created your first Prefect Project.</p>
<p>Prefect Project have a lot more to offer.</p>
<p>I encourage you to read about <a href="https://docs.prefect.io/2.10.13/concepts/projects/#templating-options">Templating Options</a> for <code>deployment.yaml</code> file that lets you refer dynamic value to the file. Also, read more about <code>prefect.yaml</code> file <a href="https://docs.prefect.io/2.10.13/concepts/projects/#the-prefect-yaml-file">here</a>.</p>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ol type="1">
<li><a href="https://docs.prefect.io/2.10.13/concepts/deployments/">Deployments</a></li>
<li><a href="https://docs.prefect.io/2.10.13/concepts/work-pools/">Work Pools, Workers &amp; Agents</a></li>
<li><a href="https://docs.prefect.io/2.10.13/concepts/storage/">Storage</a></li>
<li><a href="https://docs.prefect.io/2.10.13/concepts/schedules/">Schedules</a></li>
<li><a href="https://docs.prefect.io/2.10.13/concepts/projects/">Projects</a></li>
<li><a href="https://docs.prefect.io/2.10.13/tutorial/deployments/">Deployment Tutorial</a></li>
<li><a href="https://github.com/PrefectHQ/prefect/blob/main/docs/img/concepts/flow-deployment-end-to-end.png">End-to-End Example Image</a></li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this post, we covered the basics of Prefect deployment and how to deploy a flow. We also covered Prefect Projects and how to use it to create a deployment. In the next post, weâ€™ll cover storgae and deployment on Prefect Cloud.</p>
<p>Thank you for reading and I hope you found this notebook helpful. ðŸ‘ Upvote if you liked it, ðŸ’¬ comment if you loved it. Hope to see you guys in the next one. âœŒï¸ Peace!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/(?:http:|https:)\/\/(www\.)?sagarthacker\.com\/*|javascript\:void\(0\)/);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<script src="https://utteranc.es/client.js" repo="sagar118/sagarthacker" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Made with <a href="https://quarto.org/">Quarto</a>, by Sagar Thacker. License: <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC BY-SA 2.0</a>.</div>   
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>