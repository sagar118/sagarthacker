<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sagar Thacker">
<meta name="dcterms.date" content="2023-05-30">
<meta name="description" content="Discover the implementation of MLflow on AWS, leveraging EC2 to host MLFlow Server, S3 for artifact storage and RDS-PostgreSQL for backend entity storager.">

<title>Beyond the Dataset - MLflow on AWS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-17YZDMEKH1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-17YZDMEKH1', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="Beyond the Dataset - MLflow on AWS">
<meta name="twitter:description" content="Discover the implementation of MLflow on AWS, leveraging EC2 to host MLFlow Server, S3 for artifact storage and RDS-PostgreSQL for backend entity storager.">
<meta name="twitter:image" content="https://sagarthacker.com/posts/mlops/images/find_ec2.png">
<meta name="twitter:creator" content="@sagarthacker118">
<meta name="twitter:site" content="@sagarthacker">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Beyond the Dataset</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com" rel="" target=""><i class="bi bi-envelope" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">MLflow on AWS</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                  <div>
        <div class="description">
          Discover the implementation of MLflow on AWS, leveraging EC2 to host MLFlow Server, S3 for artifact storage and RDS-PostgreSQL for backend entity storager.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">MLOps</div>
                <div class="quarto-category">MLflow</div>
                <div class="quarto-category">AWS</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Sagar Thacker </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 30, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#create-aws-ec2-instance" id="toc-create-aws-ec2-instance" class="nav-link active" data-scroll-target="#create-aws-ec2-instance">Create AWS EC2 Instance</a></li>
  <li><a href="#configure-security-group" id="toc-configure-security-group" class="nav-link" data-scroll-target="#configure-security-group">Configure Security Group</a></li>
  <li><a href="#create-s3-bucket" id="toc-create-s3-bucket" class="nav-link" data-scroll-target="#create-s3-bucket">Create S3 Bucket</a></li>
  <li><a href="#create-rds-database" id="toc-create-rds-database" class="nav-link" data-scroll-target="#create-rds-database">Create RDS Database</a></li>
  <li><a href="#install-mlflow" id="toc-install-mlflow" class="nav-link" data-scroll-target="#install-mlflow">Install MLflow</a></li>
  <li><a href="#setup-aws-cli-and-profile-on-local" id="toc-setup-aws-cli-and-profile-on-local" class="nav-link" data-scroll-target="#setup-aws-cli-and-profile-on-local">Setup AWS CLI and Profile on local</a></li>
  <li><a href="#mlflow-in-action" id="toc-mlflow-in-action" class="nav-link" data-scroll-target="#mlflow-in-action">MLflow in Action</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#train-model" id="toc-train-model" class="nav-link" data-scroll-target="#train-model">Train Model</a></li>
  <li><a href="#hyperparameter-tuning" id="toc-hyperparameter-tuning" class="nav-link" data-scroll-target="#hyperparameter-tuning">Hyperparameter Tuning</a></li>
  <li><a href="#model-registry" id="toc-model-registry" class="nav-link" data-scroll-target="#model-registry">Model Registry</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In this blog post we explore how to set up MLflow on AWS, leveraging EC2 to host MLFlow Server, S3 for artifact storage and RDS-PostgreSQL for backend entity storager.</p>
<p>If you’re interested in learning about MLflow or need an introduction to its workings, I recommend checking out my previous blog post titled <a href="https://sagarthacker.com/posts/mlops/mlflow.html">“Introduction to MLflow”</a>.</p>
<section id="create-aws-ec2-instance" class="level2">
<h2 class="anchored" data-anchor-id="create-aws-ec2-instance">Create AWS EC2 Instance</h2>
<ol type="1">
<li>Go to <code>https://aws.amazon.com</code> to Sign in / Create an AWS Account.</li>
<li>To launch EC2 instance, click on to <code>services</code> on the left-top corner of the page. Select <code>Compute</code> and <code>EC2</code>.</li>
</ol>
<p><img src="./images/find_ec2.png" class="img-fluid"></p>
<ol start="3" type="1">
<li>To launch a new instance, click on <code>Launch Instance</code>.</li>
</ol>
<p><img src="./images/launch_instance.png" class="img-fluid"></p>
<ol start="4" type="1">
<li>Name our Instance</li>
</ol>
<p><img src="./images/aws_mlflow/instance_name.png" class="img-fluid"></p>
<ol start="5" type="1">
<li><p>Keep the default settings for <code>Application and OS Image</code>, and <code>Instance Type</code>.</p></li>
<li><p>If you don’t already have a <code>Key pair</code>, you can create a new key pair. You would be asked to download and save your key pair.</p></li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Save your key pair at <code>~/.ssh/</code> folder.</p>
</div>
</div>
<p align="center">
<img src="./images/setup_key_pair.png">
</p>
<ol start="7" type="1">
<li>Keep all the other settings as default and click on <code>Launch Instance</code>.</li>
</ol>
</section>
<section id="configure-security-group" class="level2">
<h2 class="anchored" data-anchor-id="configure-security-group">Configure Security Group</h2>
<ol type="1">
<li>After the instance is launched, click on <code>Security</code> Section on the Instance Summary Page.</li>
</ol>
<p><img src="./images/aws_mlflow/security_section.png" class="img-fluid"></p>
<ol start="2" type="1">
<li>Click on <code>Edit Inbound Rules</code> and add a new rule for <code>Custom TCP</code> with port <code>5000</code> and source. Save the changes.</li>
</ol>
<p><img src="./images/aws_mlflow/edit_security_rules.png" class="img-fluid"></p>
<p><img src="./images/aws_mlflow/ipv4_5000_rule.png" class="img-fluid"></p>
</section>
<section id="create-s3-bucket" class="level2">
<h2 class="anchored" data-anchor-id="create-s3-bucket">Create S3 Bucket</h2>
<ol type="1">
<li>Go to <code>services</code> on the left-top corner of the page. Select <code>Storage</code> and <code>S3</code>. Click on <code>Create Bucket</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/s3_bucket.png" class="img-fluid"></p>
<ol start="2" type="1">
<li>Name your bucket and select the region. Keep all the other settings as default and click on <code>Create Bucket</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/s3_bucket_name.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please make note of the <code>bucket name</code> for later use.</p>
</div>
</div>
</section>
<section id="create-rds-database" class="level2">
<h2 class="anchored" data-anchor-id="create-rds-database">Create RDS Database</h2>
<ol type="1">
<li>Go to <code>services</code> on the left-top corner of the page. Select <code>Database</code> and <code>RDS</code>. Click on <code>Create Database</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/rds.png" class="img-fluid"></p>
<ol start="2" type="1">
<li><p>Choose <code>Standard create</code> and select <code>PostgreSQL</code> as the engine.</p></li>
<li><p>Select <code>Free tier</code> in the Templates section.</p></li>
<li><p>In the Settings section, name your database i.e., DB Instance Identifier (eg. <code>mlflow-database</code>). In the Credentials section, enter a username (eg. <code>mlflow</code>) and Tick the <code>Auto generate a password</code> checkbox.</p></li>
<li><p>In the Additional configuration section, Set the <code>Initial database name</code> (eg. <code>mlflow_db</code>) under the Database options.</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please make note of the <code>username</code> and the <code>database name</code> for later use.</p>
</div>
</div>
<ol start="6" type="1">
<li><p>Keep all the other settings as default and click on <code>Create Database</code>.</p></li>
<li><p>The database would take a few minutes to be created. To check the password, click on <code>View credential details</code>.</p></li>
</ol>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>You would need the password save the password for later use. This is the only time you would be able to view the password. However, you can always reset the password.</p>
</div>
</div>
<p><img src="./images/aws_mlflow/view_credentials.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>After the database is created, please save the endpoint and port for later use. You can find the endpoint and port on the database summary page. Marked in the image below with a green dotted box.</p>
</div>
</div>
<ol start="8" type="1">
<li>Next, you would need to add an inbound rule to the security group of the database. To do so, click on the <code>Security</code> section on the database summary page. Click on <code>Edit Inbound Rules</code> and add a new rule for <code>PostgreSQL</code> with port <code>5432</code> and source. Save the changes. This allows the EC2 instance to connect to the database.</li>
</ol>
<p><img src="./images/aws_mlflow/rds_security_group.png" class="img-fluid"></p>
<p><img src="./images/aws_mlflow/edit_inbound_rules.png" class="img-fluid"></p>
<p>Select the security group that was created automatically when we launched the EC2 instance.</p>
<p><img src="./images/aws_mlflow/add_postgres_rule.png" class="img-fluid"></p>
</section>
<section id="install-mlflow" class="level2">
<h2 class="anchored" data-anchor-id="install-mlflow">Install MLflow</h2>
<ol type="1">
<li>We’ll utilize the easiest way to connect to the EC2 instance. Click on the <code>Connect</code> button on the EC2 instance summary page. In the EC2 Instance Connect section, click on <code>Connect</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/connect_to_ec2.png" class="img-fluid"></p>
<p><img src="./images/aws_mlflow/connect.png" class="img-fluid"></p>
<p>This would open a terminal window in the browser.</p>
<ol start="2" type="1">
<li>Run the following commands to install MLflow.</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">sudo</span> yum update</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ex">pip3</span> install mlflow boto3 psycopg2-binary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you get an error saying <code>No module named pip</code>, run the following command to install pip.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">python3</span> <span class="at">-m</span> ensurepip <span class="at">--upgrade</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ol start="3" type="1">
<li>Next, we need to set up the MLflow Tracking Server. To do so, run the following command.</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">mlflow</span> server <span class="at">-h</span> 0.0.0.0 <span class="at">-p</span> 5000 <span class="at">--backend-store-uri</span> postgresql://DB_USER:DB_PASSWORD@DB_ENDPOINT:PORT/DB_NAME <span class="at">--default-artifact-root</span> s3://S3_BUCKET_NAME</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># Example, Replace the following values</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ex">mlflow</span> server <span class="at">-h</span> 0.0.0.0 <span class="at">-p</span> 5000 <span class="at">--backend-store-uri</span> postgresql://mlflow:WJgpP1lv4PQVnhzdq7T5@mlflow-database.c4rrlovvb5cx.us-east-1.rds.amazonaws.com:5432/mlflow_db <span class="at">--default-artifact-root</span> s3://mlflow-artifact-remote-storage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We made note of the <code>ENDPOINT</code> and <code>PORT</code> which can be replaced for <code>DB_ENDPOINT</code> and <code>PORT</code> respectively. We also saved the <code>PASSWORD</code> when creating the RDS-Postgresql database which can be replaced for <code>DB_PASSWORD</code> respectively.</p>
<p>Similarly, we made note of the <code>USERNAME</code> and <code>DATABASE_NAME</code> which can be replaced for <code>DB_USER</code> and <code>DB_NAME</code> respectively. We also made note of the <code>BUCKET_NAME</code> which can be replaced for <code>S3_BUCKET_NAME</code>.</p>
</div>
</div>
<ol start="4" type="1">
<li>To checkout the MLflow UI, open a new tab in the browser and enter the following URL.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">http://EC2_INSTANCE_PUBLIC_IPv4_ADDRESS:5000</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># Example, Replace the following values</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ex">http://52.91.235.206:5000/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="./images/aws_mlflow/mlflow_ui.png" class="img-fluid"></p>
<p>Voila! You have successfully set up MLflow on AWS EC2 instance.</p>
</section>
<section id="setup-aws-cli-and-profile-on-local" class="level2">
<h2 class="anchored" data-anchor-id="setup-aws-cli-and-profile-on-local">Setup AWS CLI and Profile on local</h2>
<ol type="1">
<li>Install AWS CLI on your local machine. You can follow the instructions <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">here</a>.</li>
<li>Go to IAM on AWS Console and click on Policies on the left panel. Click on <code>Create Policy</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/create_policy.png" class="img-fluid"></p>
<ol start="3" type="1">
<li>Search for <code>S3</code> and click on s3.</li>
</ol>
<p><img src="./images/aws_mlflow/permission.png" class="img-fluid"></p>
<ol start="4" type="1">
<li>Select all the access level for <code>List</code>, and <code>Read</code>. Select all the marked options for <code>Write</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/read_list.png" class="img-fluid"></p>
<p><img src="./images/aws_mlflow/write.png" class="img-fluid"></p>
<ol start="5" type="1">
<li>Mark all the checkboxes in the Resources section. Click on <code>Next</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/resources.png" class="img-fluid"></p>
<ol start="6" type="1">
<li>Give the name for the Policy and click on <code>Create Policy</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/policy_name.png" class="img-fluid"></p>
<ol start="7" type="1">
<li>Go to IAM and click on <code>UsersGroup</code> on the left panel. Click on <code>Create group</code>. Give a name for the group and select the policy that was created in the previous step. Click on <code>Create group</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/user_group.png" class="img-fluid"></p>
<ol start="8" type="1">
<li>Go to IAM and click on <code>Users</code> on the left panel. Click on <code>Add user</code>. Give a name for the user and click on Next.</li>
</ol>
<p><img src="./images/aws_mlflow/add_users.png" class="img-fluid"></p>
<p><img src="./images/aws_mlflow/create_user.png" class="img-fluid"></p>
<ol start="9" type="1">
<li>Select <code>Add user to group</code> Permission option and select the group that was created in the previous step. Click on <code>Next</code>. Review the details and click on <code>Create user</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/user_to_group.png" class="img-fluid"></p>
<ol start="10" type="1">
<li>Go to <code>Users</code> again and click on the user that was created in the previous step. Click on <code>Security credentials</code> tab. Click on <code>Create access key</code>.</li>
</ol>
<p><img src="./images/aws_mlflow/create_access_key.png" class="img-fluid"></p>
<ol start="11" type="1">
<li><p>Click on <code>Other</code> and click on <code>Next</code> Button. Then Click on <code>Create Access Key</code>.</p></li>
<li><p>Click on <code>Download .csv file</code> and save the file. This file contains the <code>Access Key ID</code> and <code>Secret Access Key</code> which would be used to configure the AWS CLI.</p></li>
<li><p>Open the terminal and run the following command.</p></li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">aws</span> configure</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="14" type="1">
<li><p>Enter the <code>Access Key ID</code> and <code>Secret Access Key</code> that was saved in the previous step. For other options like <code>Default region name</code> and <code>Default output format</code>, keep the default values by pressing enter.</p></li>
<li><p>You can check if the AWS CLI is configured correctly by running the following command.</p></li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">aws</span> s3 ls</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should be able to see the list of buckets that are present in your AWS account.</p>
</section>
<section id="mlflow-in-action" class="level2">
<h2 class="anchored" data-anchor-id="mlflow-in-action">MLflow in Action</h2>
<p>I’ll refer to the <a href="http://localhost:4308/posts/mlops/mlflow.html">Introduction to MLflow</a> post for this section. I’ll be using the same code and data for this section.</p>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<p>Create a new virtual environment and install MLflow and other libraries using the following command:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">mlflow</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ex">jupyter</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="ex">scikit-learn</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="ex">pandas</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="ex">xgboost</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="ex">fastparquet</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="ex">hyperopt</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="ex">optuna</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Create conda environment</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">conda</span> create <span class="at">-p</span> venv python=3.9 <span class="at">-y</span></span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># Activate conda environment</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="ex">conda</span> activate venv/</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co"># Install required libraries</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt <span class="at">--no-cache-dir</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Download the dataset using the following command:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># Create data directory</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">mkdir</span> data</span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co"># Move to data directory</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="bu">cd</span> data</span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co"># Download dataset</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="fu">wget</span> https://d37ci6vzurychx.cloudfront.net/trip-data/green_tripdata_2022-01.parquet <span class="co"># January 2022</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="fu">wget</span> https://d37ci6vzurychx.cloudfront.net/trip-data/green_tripdata_2022-02.parquet <span class="co"># February 2022</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="fu">wget</span> https://d37ci6vzurychx.cloudfront.net/trip-data/green_tripdata_2022-03.parquet <span class="co"># March 2022</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We’ll also create a jupyter notebook named <code>mlflow.ipynb</code> to run our experiment. After following the above steps, you should have the following directory structure:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="bu">.</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ex">├──</span> data</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="ex">│</span>   ├── green_tripdata_2022-01.parquet</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="ex">│</span>   ├── green_tripdata_2022-02.parquet</span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="ex">│</span>   └── green_tripdata_2022-03.parquet</span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="ex">├──</span> mlflow.ipynb</span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="ex">├──</span> requirements.txt</span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="ex">└──</span> venv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The below hidden code block imports the required libraries, loads &amp; transforms the dataset, and splits the dataset into train, validation, and test sets.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="im">import</span> os</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="im">import</span> pickle</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="im">import</span> mlflow</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="im">import</span> optuna</span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="im">from</span> mlflow.entities <span class="im">import</span> ViewType</span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="im">from</span> mlflow.tracking <span class="im">import</span> MlflowClient</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="im">from</span> optuna.samplers <span class="im">import</span> TPESampler</span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="im">from</span> sklearn.feature_extraction <span class="im">import</span> DictVectorizer</span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression, Lasso</span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb11-15"><a href="#cb11-15"></a></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="kw">def</span> read_dataframe(filename: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb11-17"><a href="#cb11-17"></a>    <span class="co">"""</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="co">    Reads a Parquet file into a pandas DataFrame, performs data transformations, and returns the resulting DataFrame.</span></span>
<span id="cb11-19"><a href="#cb11-19"></a></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="co">    Parameters:</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="co">        filename (str): The path to the Parquet file to be read.</span></span>
<span id="cb11-22"><a href="#cb11-22"></a></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="co">    Returns:</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="co">        pandas.DataFrame: The processed DataFrame containing the data from the Parquet file.</span></span>
<span id="cb11-25"><a href="#cb11-25"></a></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="co">    Raises:</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="co">        [Any exceptions raised by pandas.read_parquet()]</span></span>
<span id="cb11-28"><a href="#cb11-28"></a></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="co">    Notes:</span></span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="co">        - The function performs the following transformations on the DataFrame:</span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="co">            - Converts 'lpep_dropoff_datetime' and 'lpep_pickup_datetime' columns to pandas datetime objects.</span></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="co">            - Computes the 'duration' column by subtracting 'lpep_pickup_datetime' from 'lpep_dropoff_datetime'</span></span>
<span id="cb11-33"><a href="#cb11-33"></a><span class="co">              and converting the result to minutes.</span></span>
<span id="cb11-34"><a href="#cb11-34"></a><span class="co">            - Filters the DataFrame to include rows where the 'duration' is between 1 and 60 minutes (inclusive).</span></span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="co">            - Converts 'PULocationID' and 'DOLocationID' columns to string type.</span></span>
<span id="cb11-36"><a href="#cb11-36"></a></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="co">    Example:</span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="co">        filename = 'data.parquet'</span></span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="co">        df = read_dataframe(filename)</span></span>
<span id="cb11-40"><a href="#cb11-40"></a><span class="co">    """</span></span>
<span id="cb11-41"><a href="#cb11-41"></a>    <span class="co"># Read the Parquet file into a DataFrame</span></span>
<span id="cb11-42"><a href="#cb11-42"></a>    df <span class="op">=</span> pd.read_parquet(filename)</span>
<span id="cb11-43"><a href="#cb11-43"></a></span>
<span id="cb11-44"><a href="#cb11-44"></a>    <span class="co"># Convert 'lpep_dropoff_datetime' and 'lpep_pickup_datetime' columns to pandas datetime objects</span></span>
<span id="cb11-45"><a href="#cb11-45"></a>    df.lpep_dropoff_datetime <span class="op">=</span> pd.to_datetime(df.lpep_dropoff_datetime)</span>
<span id="cb11-46"><a href="#cb11-46"></a>    df.lpep_pickup_datetime <span class="op">=</span> pd.to_datetime(df.lpep_pickup_datetime)</span>
<span id="cb11-47"><a href="#cb11-47"></a></span>
<span id="cb11-48"><a href="#cb11-48"></a>    <span class="co"># Compute the 'duration' column by subtracting 'lpep_pickup_datetime' from 'lpep_dropoff_datetime' and converting to minutes</span></span>
<span id="cb11-49"><a href="#cb11-49"></a>    df[<span class="st">'duration'</span>] <span class="op">=</span> df.lpep_dropoff_datetime <span class="op">-</span> df.lpep_pickup_datetime</span>
<span id="cb11-50"><a href="#cb11-50"></a>    df.duration <span class="op">=</span> df.duration.<span class="bu">apply</span>(<span class="kw">lambda</span> td: td.total_seconds() <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb11-51"><a href="#cb11-51"></a></span>
<span id="cb11-52"><a href="#cb11-52"></a>    <span class="co"># Filter the DataFrame to include rows where the 'duration' is between 1 and 60 minutes (inclusive)</span></span>
<span id="cb11-53"><a href="#cb11-53"></a>    df <span class="op">=</span> df[(df.duration <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (df.duration <span class="op">&lt;=</span> <span class="dv">60</span>)]</span>
<span id="cb11-54"><a href="#cb11-54"></a></span>
<span id="cb11-55"><a href="#cb11-55"></a>    <span class="co"># Convert 'PULocationID' and 'DOLocationID' columns to string type</span></span>
<span id="cb11-56"><a href="#cb11-56"></a>    categorical <span class="op">=</span> [<span class="st">'PULocationID'</span>, <span class="st">'DOLocationID'</span>]</span>
<span id="cb11-57"><a href="#cb11-57"></a>    df[categorical] <span class="op">=</span> df[categorical].astype(<span class="bu">str</span>)</span>
<span id="cb11-58"><a href="#cb11-58"></a>    </span>
<span id="cb11-59"><a href="#cb11-59"></a>    <span class="co"># Return the processed DataFrame</span></span>
<span id="cb11-60"><a href="#cb11-60"></a>    <span class="cf">return</span> df</span>
<span id="cb11-61"><a href="#cb11-61"></a></span>
<span id="cb11-62"><a href="#cb11-62"></a><span class="co"># Read the Parquet file for training data into a DataFrame</span></span>
<span id="cb11-63"><a href="#cb11-63"></a>df_train <span class="op">=</span> read_dataframe(<span class="st">'./data/green_tripdata_2022-01.parquet'</span>)</span>
<span id="cb11-64"><a href="#cb11-64"></a></span>
<span id="cb11-65"><a href="#cb11-65"></a><span class="co"># Read the Parquet file for validation data into a DataFrame</span></span>
<span id="cb11-66"><a href="#cb11-66"></a>df_val <span class="op">=</span> read_dataframe(<span class="st">'./data/green_tripdata_2022-02.parquet'</span>)</span>
<span id="cb11-67"><a href="#cb11-67"></a></span>
<span id="cb11-68"><a href="#cb11-68"></a><span class="co"># Read the Parquet file for testing data into a DataFrame</span></span>
<span id="cb11-69"><a href="#cb11-69"></a>df_test <span class="op">=</span> read_dataframe(<span class="st">'./data/green_tripdata_2022-03.parquet'</span>)</span>
<span id="cb11-70"><a href="#cb11-70"></a></span>
<span id="cb11-71"><a href="#cb11-71"></a><span class="kw">def</span> preprocess(df: pd.DataFrame, dv: DictVectorizer, fit_dv: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb11-72"><a href="#cb11-72"></a>    <span class="co">"""</span></span>
<span id="cb11-73"><a href="#cb11-73"></a><span class="co">    Preprocesses a pandas DataFrame by creating new features, transforming categorical features into a numerical format,</span></span>
<span id="cb11-74"><a href="#cb11-74"></a><span class="co">    and returning the transformed data along with the DictVectorizer.</span></span>
<span id="cb11-75"><a href="#cb11-75"></a></span>
<span id="cb11-76"><a href="#cb11-76"></a><span class="co">    Parameters:</span></span>
<span id="cb11-77"><a href="#cb11-77"></a><span class="co">        df (pandas.DataFrame): The input DataFrame to be preprocessed.</span></span>
<span id="cb11-78"><a href="#cb11-78"></a><span class="co">        dv (sklearn.feature_extraction.DictVectorizer): The DictVectorizer instance to be used for transforming categorical features.</span></span>
<span id="cb11-79"><a href="#cb11-79"></a><span class="co">        fit_dv (bool, optional): Indicates whether to fit the DictVectorizer on the data. Defaults to False.</span></span>
<span id="cb11-80"><a href="#cb11-80"></a></span>
<span id="cb11-81"><a href="#cb11-81"></a><span class="co">    Returns:</span></span>
<span id="cb11-82"><a href="#cb11-82"></a><span class="co">        tuple: A tuple containing the transformed feature matrix and the DictVectorizer instance.</span></span>
<span id="cb11-83"><a href="#cb11-83"></a></span>
<span id="cb11-84"><a href="#cb11-84"></a><span class="co">    Notes:</span></span>
<span id="cb11-85"><a href="#cb11-85"></a><span class="co">        - The function assumes that the DataFrame contains the columns 'PULocationID' and 'DOLocationID'.</span></span>
<span id="cb11-86"><a href="#cb11-86"></a><span class="co">        - The function creates a new feature 'PU_DO' by concatenating 'PULocationID' and 'DOLocationID'.</span></span>
<span id="cb11-87"><a href="#cb11-87"></a><span class="co">        - The categorical feature 'PU_DO' and numerical feature 'trip_distance' are selected for transformation.</span></span>
<span id="cb11-88"><a href="#cb11-88"></a><span class="co">        - The function transforms the selected features into a dictionary representation and applies the DictVectorizer.</span></span>
<span id="cb11-89"><a href="#cb11-89"></a><span class="co">        - If fit_dv is True, the DictVectorizer is fitted on the data. Otherwise, the existing fitted DictVectorizer is used.</span></span>
<span id="cb11-90"><a href="#cb11-90"></a></span>
<span id="cb11-91"><a href="#cb11-91"></a><span class="co">    Example:</span></span>
<span id="cb11-92"><a href="#cb11-92"></a><span class="co">        df = read_dataframe('data.parquet')</span></span>
<span id="cb11-93"><a href="#cb11-93"></a><span class="co">        dv = DictVectorizer()</span></span>
<span id="cb11-94"><a href="#cb11-94"></a><span class="co">        X, dv = preprocess(df, dv, fit_dv=True)</span></span>
<span id="cb11-95"><a href="#cb11-95"></a><span class="co">    """</span></span>
<span id="cb11-96"><a href="#cb11-96"></a>    <span class="co"># Create a new feature 'PU_DO' by concatenating 'PULocationID' and 'DOLocationID'</span></span>
<span id="cb11-97"><a href="#cb11-97"></a>    df[<span class="st">'PU_DO'</span>] <span class="op">=</span> df[<span class="st">'PULocationID'</span>] <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> df[<span class="st">'DOLocationID'</span>]</span>
<span id="cb11-98"><a href="#cb11-98"></a></span>
<span id="cb11-99"><a href="#cb11-99"></a>    <span class="co"># Select categorical and numerical features for transformation</span></span>
<span id="cb11-100"><a href="#cb11-100"></a>    categorical <span class="op">=</span> [<span class="st">'PU_DO'</span>]</span>
<span id="cb11-101"><a href="#cb11-101"></a>    numerical <span class="op">=</span> [<span class="st">'trip_distance'</span>]</span>
<span id="cb11-102"><a href="#cb11-102"></a></span>
<span id="cb11-103"><a href="#cb11-103"></a>    <span class="co"># Convert the selected features into a dictionary representation</span></span>
<span id="cb11-104"><a href="#cb11-104"></a>    dicts <span class="op">=</span> df[categorical <span class="op">+</span> numerical].to_dict(orient<span class="op">=</span><span class="st">'records'</span>)</span>
<span id="cb11-105"><a href="#cb11-105"></a></span>
<span id="cb11-106"><a href="#cb11-106"></a>    <span class="co"># Apply DictVectorizer for transforming categorical features</span></span>
<span id="cb11-107"><a href="#cb11-107"></a>    <span class="cf">if</span> fit_dv:</span>
<span id="cb11-108"><a href="#cb11-108"></a>        <span class="co"># Fit the DictVectorizer on the data</span></span>
<span id="cb11-109"><a href="#cb11-109"></a>        X <span class="op">=</span> dv.fit_transform(dicts)</span>
<span id="cb11-110"><a href="#cb11-110"></a>    <span class="cf">else</span>:</span>
<span id="cb11-111"><a href="#cb11-111"></a>        <span class="co"># Transform using the existing fitted DictVectorizer</span></span>
<span id="cb11-112"><a href="#cb11-112"></a>        X <span class="op">=</span> dv.transform(dicts)</span>
<span id="cb11-113"><a href="#cb11-113"></a></span>
<span id="cb11-114"><a href="#cb11-114"></a>    <span class="co"># Return the transformed feature matrix and DictVectorizer</span></span>
<span id="cb11-115"><a href="#cb11-115"></a>    <span class="cf">return</span> X, dv</span>
<span id="cb11-116"><a href="#cb11-116"></a></span>
<span id="cb11-117"><a href="#cb11-117"></a><span class="co"># Extract the target variable</span></span>
<span id="cb11-118"><a href="#cb11-118"></a>target <span class="op">=</span> <span class="st">'duration'</span></span>
<span id="cb11-119"><a href="#cb11-119"></a></span>
<span id="cb11-120"><a href="#cb11-120"></a><span class="co"># Extract the target variable from the training, validation and testing datasets</span></span>
<span id="cb11-121"><a href="#cb11-121"></a>y_train <span class="op">=</span> df_train[target].values</span>
<span id="cb11-122"><a href="#cb11-122"></a>y_val <span class="op">=</span> df_val[target].values</span>
<span id="cb11-123"><a href="#cb11-123"></a>y_test <span class="op">=</span> df_test[target].values</span>
<span id="cb11-124"><a href="#cb11-124"></a></span>
<span id="cb11-125"><a href="#cb11-125"></a><span class="co"># Initialize a DictVectorizer for preprocessing</span></span>
<span id="cb11-126"><a href="#cb11-126"></a>dv <span class="op">=</span> DictVectorizer()</span>
<span id="cb11-127"><a href="#cb11-127"></a></span>
<span id="cb11-128"><a href="#cb11-128"></a><span class="co"># Preprocess the training data</span></span>
<span id="cb11-129"><a href="#cb11-129"></a>X_train, dv <span class="op">=</span> preprocess(df_train, dv, fit_dv<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-130"><a href="#cb11-130"></a></span>
<span id="cb11-131"><a href="#cb11-131"></a><span class="co"># Preprocess the validation data using the fitted DictVectorizer from the training data</span></span>
<span id="cb11-132"><a href="#cb11-132"></a>X_val, _ <span class="op">=</span> preprocess(df_val, dv, fit_dv<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-133"><a href="#cb11-133"></a></span>
<span id="cb11-134"><a href="#cb11-134"></a><span class="co"># Preprocess the testing data using the fitted DictVectorizer from the training data</span></span>
<span id="cb11-135"><a href="#cb11-135"></a>X_test, _ <span class="op">=</span> preprocess(df_test, dv, fit_dv<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-136"><a href="#cb11-136"></a></span>
<span id="cb11-137"><a href="#cb11-137"></a><span class="kw">def</span> dump_pickle(obj, filename: <span class="bu">str</span>):</span>
<span id="cb11-138"><a href="#cb11-138"></a>    <span class="co">"""</span></span>
<span id="cb11-139"><a href="#cb11-139"></a><span class="co">    Pickles (serializes) an object and saves it to a file.</span></span>
<span id="cb11-140"><a href="#cb11-140"></a></span>
<span id="cb11-141"><a href="#cb11-141"></a><span class="co">    Parameters:</span></span>
<span id="cb11-142"><a href="#cb11-142"></a><span class="co">        obj (Any): The object to be pickled.</span></span>
<span id="cb11-143"><a href="#cb11-143"></a><span class="co">        filename (str): The path and filename to save the pickled object.</span></span>
<span id="cb11-144"><a href="#cb11-144"></a></span>
<span id="cb11-145"><a href="#cb11-145"></a><span class="co">    Returns:</span></span>
<span id="cb11-146"><a href="#cb11-146"></a><span class="co">        None</span></span>
<span id="cb11-147"><a href="#cb11-147"></a></span>
<span id="cb11-148"><a href="#cb11-148"></a><span class="co">    Notes:</span></span>
<span id="cb11-149"><a href="#cb11-149"></a><span class="co">        - The function uses the 'pickle' module to serialize the object and save it to a file.</span></span>
<span id="cb11-150"><a href="#cb11-150"></a><span class="co">        - The file is opened in binary mode for writing using the "wb" mode.</span></span>
<span id="cb11-151"><a href="#cb11-151"></a><span class="co">    """</span></span>
<span id="cb11-152"><a href="#cb11-152"></a>    <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">"wb"</span>) <span class="im">as</span> f_out:</span>
<span id="cb11-153"><a href="#cb11-153"></a>        <span class="cf">return</span> pickle.dump(obj, f_out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Set up the MLflow Tracking Server URI.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>TRACKING_SERVER_HOST <span class="op">=</span> <span class="st">"52.91.235.206"</span> <span class="co"># fill in with the public IPv4 of the EC2 instance</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>mlflow.set_tracking_uri(<span class="ss">f"http://</span><span class="sc">{</span>TRACKING_SERVER_HOST<span class="sc">}</span><span class="ss">:5000"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="bu">print</span>(<span class="ss">f"tracking URI: '</span><span class="sc">{</span>mlflow<span class="sc">.</span>get_tracking_uri()<span class="sc">}</span><span class="ss">'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tracking URI: 'http://52.91.235.206:5000'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># Create a new experiment</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>mlflow.set_experiment(<span class="st">"nyc-taxi-experiment"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2023/05/31 11:43:55 INFO mlflow.tracking.fluent: Experiment with name 'nyc-taxi-experiment' does not exist. Creating a new experiment.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>&lt;Experiment: artifact_location='s3://mlflow-artifact-remote-storage/1', creation_time=1685547835140, experiment_id='1', last_update_time=1685547835140, lifecycle_stage='active', name='nyc-taxi-experiment', tags={}&gt;</code></pre>
</div>
</div>
</section>
<section id="train-model" class="level3">
<h3 class="anchored" data-anchor-id="train-model">Train Model</h3>
<p>Train a simple Linear Regression model and log the model parameters, metrics, and artifacts.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># Specify the destination path for saving model files</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>model_path <span class="op">=</span> <span class="st">"./outputs/models"</span></span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co"># Start an MLflow run</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="cf">with</span> mlflow.start_run():</span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="co"># Set a tag for the developer</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>    mlflow.set_tag(<span class="st">"developer"</span>, <span class="st">"Sagar"</span>)</span>
<span id="cb18-8"><a href="#cb18-8"></a></span>
<span id="cb18-9"><a href="#cb18-9"></a>    <span class="co"># Initialize and train a LinearRegression model</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>    lr <span class="op">=</span> LinearRegression()</span>
<span id="cb18-11"><a href="#cb18-11"></a>    lr.fit(X_train, y_train)</span>
<span id="cb18-12"><a href="#cb18-12"></a></span>
<span id="cb18-13"><a href="#cb18-13"></a>    <span class="co"># Make predictions on the validation data</span></span>
<span id="cb18-14"><a href="#cb18-14"></a>    yhat <span class="op">=</span> lr.predict(X_val)</span>
<span id="cb18-15"><a href="#cb18-15"></a></span>
<span id="cb18-16"><a href="#cb18-16"></a>    <span class="co"># Calculate the root mean squared error (RMSE)</span></span>
<span id="cb18-17"><a href="#cb18-17"></a>    rmse <span class="op">=</span> mean_squared_error(y_val, yhat, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb18-18"><a href="#cb18-18"></a></span>
<span id="cb18-19"><a href="#cb18-19"></a>    <span class="co"># Log the RMSE metric to MLflow</span></span>
<span id="cb18-20"><a href="#cb18-20"></a>    mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb18-21"><a href="#cb18-21"></a></span>
<span id="cb18-22"><a href="#cb18-22"></a>    <span class="co"># Create dest_path folder unless it already exists</span></span>
<span id="cb18-23"><a href="#cb18-23"></a>    os.makedirs(model_path, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-24"><a href="#cb18-24"></a></span>
<span id="cb18-25"><a href="#cb18-25"></a>    <span class="co"># Save the trained model as a pickle file</span></span>
<span id="cb18-26"><a href="#cb18-26"></a>    dump_pickle(lr, os.path.join(model_path, <span class="st">"lin_reg.pkl"</span>))</span>
<span id="cb18-27"><a href="#cb18-27"></a></span>
<span id="cb18-28"><a href="#cb18-28"></a>    <span class="co"># Log the trained model as an artifact to MLflow</span></span>
<span id="cb18-29"><a href="#cb18-29"></a>    mlflow.log_artifact(local_path<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_path<span class="sc">}</span><span class="ss">/lin_reg.pkl"</span>, artifact_path<span class="op">=</span><span class="st">"model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below you can see the MLflow UI with the experiment run.</p>
<p><img src="./images/aws_mlflow/lin_reg_exp.png" class="img-fluid"></p>
<p><img src="./images/aws_mlflow/lin_reg_exp_details.png" class="img-fluid"></p>
<p>You can also see that the artifacts are stored in S3 bucket.</p>
<p><img src="./images/aws_mlflow/s3_artifacts.png" class="img-fluid"></p>
</section>
<section id="hyperparameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning">Hyperparameter Tuning</h3>
<p>Next, we’ll create a new experiment to perform hyperparameter tuning using Hyperopt and Optuna.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Create a new experiment</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>mlflow.set_experiment(<span class="st">"random-forest-hyperopt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>&lt;Experiment: artifact_location='s3://mlflow-artifact-remote-storage/3', creation_time=1685548270366, experiment_id='3', last_update_time=1685548270366, lifecycle_stage='active', name='random-forest-hyperopt', tags={}&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">def</span> run_optimization(num_trials: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>):</span>
<span id="cb21-2"><a href="#cb21-2"></a>    <span class="co">"""</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co">    Runs the optimization process using Optuna library to find the optimal hyperparameters for RandomForestRegressor.</span></span>
<span id="cb21-4"><a href="#cb21-4"></a></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="co">    Parameters:</span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co">        num_trials (int): The number of optimization trials to perform. Default is 10.</span></span>
<span id="cb21-7"><a href="#cb21-7"></a></span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="co">    Returns:</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="co">        None</span></span>
<span id="cb21-10"><a href="#cb21-10"></a></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="co">    Notes:</span></span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="co">        - The function defines an objective function for Optuna to minimize the root mean squared error (RMSE).</span></span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="co">        - The objective function samples hyperparameters, trains a RandomForestRegressor model with those hyperparameters,</span></span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="co">          evaluates the model on the validation data, and logs the RMSE metric to MLflow.</span></span>
<span id="cb21-15"><a href="#cb21-15"></a><span class="co">        - Optuna performs the optimization process by searching for the set of hyperparameters that minimizes the RMSE.</span></span>
<span id="cb21-16"><a href="#cb21-16"></a><span class="co">    """</span></span>
<span id="cb21-17"><a href="#cb21-17"></a></span>
<span id="cb21-18"><a href="#cb21-18"></a>    <span class="kw">def</span> objective(trial):</span>
<span id="cb21-19"><a href="#cb21-19"></a>        <span class="co">"""</span></span>
<span id="cb21-20"><a href="#cb21-20"></a><span class="co">        Objective function for Optuna optimization.</span></span>
<span id="cb21-21"><a href="#cb21-21"></a></span>
<span id="cb21-22"><a href="#cb21-22"></a><span class="co">        Parameters:</span></span>
<span id="cb21-23"><a href="#cb21-23"></a><span class="co">            trial (optuna.Trial): A trial object representing a single optimization trial.</span></span>
<span id="cb21-24"><a href="#cb21-24"></a></span>
<span id="cb21-25"><a href="#cb21-25"></a><span class="co">        Returns:</span></span>
<span id="cb21-26"><a href="#cb21-26"></a><span class="co">            float: The value of the objective function (RMSE).</span></span>
<span id="cb21-27"><a href="#cb21-27"></a></span>
<span id="cb21-28"><a href="#cb21-28"></a><span class="co">        Notes:</span></span>
<span id="cb21-29"><a href="#cb21-29"></a><span class="co">            - The objective function samples hyperparameters from the defined search space.</span></span>
<span id="cb21-30"><a href="#cb21-30"></a><span class="co">            - It initializes and trains a RandomForestRegressor model with the sampled hyperparameters.</span></span>
<span id="cb21-31"><a href="#cb21-31"></a><span class="co">            - The model is evaluated on the validation data, and the RMSE is calculated.</span></span>
<span id="cb21-32"><a href="#cb21-32"></a><span class="co">            - The RMSE and the sampled hyperparameters are logged to MLflow.</span></span>
<span id="cb21-33"><a href="#cb21-33"></a><span class="co">        """</span></span>
<span id="cb21-34"><a href="#cb21-34"></a>        params <span class="op">=</span> {</span>
<span id="cb21-35"><a href="#cb21-35"></a>            <span class="st">'n_estimators'</span>: trial.suggest_int(<span class="st">'n_estimators'</span>, <span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">1</span>),</span>
<span id="cb21-36"><a href="#cb21-36"></a>            <span class="st">'max_depth'</span>: trial.suggest_int(<span class="st">'max_depth'</span>, <span class="dv">1</span>, <span class="dv">20</span>, <span class="dv">1</span>),</span>
<span id="cb21-37"><a href="#cb21-37"></a>            <span class="st">'min_samples_split'</span>: trial.suggest_int(<span class="st">'min_samples_split'</span>, <span class="dv">2</span>, <span class="dv">10</span>, <span class="dv">1</span>),</span>
<span id="cb21-38"><a href="#cb21-38"></a>            <span class="st">'min_samples_leaf'</span>: trial.suggest_int(<span class="st">'min_samples_leaf'</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>),</span>
<span id="cb21-39"><a href="#cb21-39"></a>            <span class="st">'random_state'</span>: <span class="dv">42</span>,</span>
<span id="cb21-40"><a href="#cb21-40"></a>            <span class="st">'n_jobs'</span>: <span class="op">-</span><span class="dv">1</span></span>
<span id="cb21-41"><a href="#cb21-41"></a>        }</span>
<span id="cb21-42"><a href="#cb21-42"></a>        </span>
<span id="cb21-43"><a href="#cb21-43"></a>        <span class="co"># Start a new MLflow run for each trial</span></span>
<span id="cb21-44"><a href="#cb21-44"></a>        <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb21-45"><a href="#cb21-45"></a>            <span class="co"># Set a tag for the model type</span></span>
<span id="cb21-46"><a href="#cb21-46"></a>            mlflow.set_tag(<span class="st">"model"</span>, <span class="st">"RandomForestRegressor"</span>)</span>
<span id="cb21-47"><a href="#cb21-47"></a>            </span>
<span id="cb21-48"><a href="#cb21-48"></a>            <span class="co"># Log the sampled hyperparameters to MLflow</span></span>
<span id="cb21-49"><a href="#cb21-49"></a>            mlflow.log_params(params)</span>
<span id="cb21-50"><a href="#cb21-50"></a></span>
<span id="cb21-51"><a href="#cb21-51"></a>            <span class="co"># Initialize a RandomForestRegressor model with the sampled hyperparameters</span></span>
<span id="cb21-52"><a href="#cb21-52"></a>            rf <span class="op">=</span> RandomForestRegressor(<span class="op">**</span>params)</span>
<span id="cb21-53"><a href="#cb21-53"></a></span>
<span id="cb21-54"><a href="#cb21-54"></a>            <span class="co"># Train the model on the training data</span></span>
<span id="cb21-55"><a href="#cb21-55"></a>            rf.fit(X_train, y_train)</span>
<span id="cb21-56"><a href="#cb21-56"></a></span>
<span id="cb21-57"><a href="#cb21-57"></a>            <span class="co"># Make predictions on the validation data</span></span>
<span id="cb21-58"><a href="#cb21-58"></a>            y_pred <span class="op">=</span> rf.predict(X_val)</span>
<span id="cb21-59"><a href="#cb21-59"></a></span>
<span id="cb21-60"><a href="#cb21-60"></a>            <span class="co"># Calculate the root mean squared error (RMSE)</span></span>
<span id="cb21-61"><a href="#cb21-61"></a>            rmse <span class="op">=</span> mean_squared_error(y_val, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-62"><a href="#cb21-62"></a></span>
<span id="cb21-63"><a href="#cb21-63"></a>            <span class="co"># Log the RMSE metric to MLflow</span></span>
<span id="cb21-64"><a href="#cb21-64"></a>            mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb21-65"><a href="#cb21-65"></a></span>
<span id="cb21-66"><a href="#cb21-66"></a>        <span class="cf">return</span> rmse</span>
<span id="cb21-67"><a href="#cb21-67"></a></span>
<span id="cb21-68"><a href="#cb21-68"></a>    <span class="co"># Use the Tree-structured Parzen Estimator (TPE) sampler for efficient hyperparameter search</span></span>
<span id="cb21-69"><a href="#cb21-69"></a>    sampler <span class="op">=</span> TPESampler(seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb21-70"><a href="#cb21-70"></a></span>
<span id="cb21-71"><a href="#cb21-71"></a>    <span class="co"># Create an Optuna study with the defined objective function and search direction</span></span>
<span id="cb21-72"><a href="#cb21-72"></a>    study <span class="op">=</span> optuna.create_study(direction<span class="op">=</span><span class="st">"minimize"</span>, sampler<span class="op">=</span>sampler)</span>
<span id="cb21-73"><a href="#cb21-73"></a></span>
<span id="cb21-74"><a href="#cb21-74"></a>    <span class="co"># Run the optimization process with the specified number of trials</span></span>
<span id="cb21-75"><a href="#cb21-75"></a>    study.optimize(objective, n_trials<span class="op">=</span>num_trials)</span>
<span id="cb21-76"><a href="#cb21-76"></a></span>
<span id="cb21-77"><a href="#cb21-77"></a>run_optimization()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[I 2023-05-31 11:57:34,678] A new study created in memory with name: no-name-41ada3cf-dabd-4100-a384-dd6a2ee09103
[I 2023-05-31 11:57:38,080] Trial 0 finished with value: 6.012747224033297 and parameters: {'n_estimators': 25, 'max_depth': 20, 'min_samples_split': 8, 'min_samples_leaf': 3}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:38,649] Trial 1 finished with value: 6.249433998787504 and parameters: {'n_estimators': 16, 'max_depth': 4, 'min_samples_split': 2, 'min_samples_leaf': 4}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:42,149] Trial 2 finished with value: 6.039045655830305 and parameters: {'n_estimators': 34, 'max_depth': 15, 'min_samples_split': 2, 'min_samples_leaf': 4}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:43,620] Trial 3 finished with value: 6.179387143797027 and parameters: {'n_estimators': 44, 'max_depth': 5, 'min_samples_split': 3, 'min_samples_leaf': 1}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:45,445] Trial 4 finished with value: 6.075505898039151 and parameters: {'n_estimators': 22, 'max_depth': 11, 'min_samples_split': 5, 'min_samples_leaf': 2}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:46,134] Trial 5 finished with value: 6.441117537172997 and parameters: {'n_estimators': 35, 'max_depth': 3, 'min_samples_split': 4, 'min_samples_leaf': 2}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:49,416] Trial 6 finished with value: 6.0285791267371165 and parameters: {'n_estimators': 28, 'max_depth': 16, 'min_samples_split': 3, 'min_samples_leaf': 3}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:49,958] Trial 7 finished with value: 7.881244954282265 and parameters: {'n_estimators': 34, 'max_depth': 1, 'min_samples_split': 7, 'min_samples_leaf': 1}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:51,295] Trial 8 finished with value: 6.025608014492215 and parameters: {'n_estimators': 12, 'max_depth': 19, 'min_samples_split': 10, 'min_samples_leaf': 4}. Best is trial 0 with value: 6.012747224033297.
[I 2023-05-31 11:57:51,848] Trial 9 finished with value: 7.071070856187059 and parameters: {'n_estimators': 22, 'max_depth': 2, 'min_samples_split': 8, 'min_samples_leaf': 2}. Best is trial 0 with value: 6.012747224033297.</code></pre>
</div>
</div>
<p><img src="./images/aws_mlflow/hyperparameter_tuning.png" class="img-fluid"></p>
</section>
<section id="model-registry" class="level3">
<h3 class="anchored" data-anchor-id="model-registry">Model Registry</h3>
<p>Finally, we’ll take the top 5 models from the hyperparameter tuning experiment and run them on the test dataset. We’ll log the metrics and artifacts for each model. We’ll register the model with the best metrics to the model registry.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Hyperparameter optimization experiment name</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>HPO_EXPERIMENT_NAME <span class="op">=</span> <span class="st">"random-forest-hyperopt"</span></span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co"># Best model experiment name</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>EXPERIMENT_NAME <span class="op">=</span> <span class="st">"random-forest-best-models"</span></span>
<span id="cb23-6"><a href="#cb23-6"></a></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="co"># Create a new experiment for the best models</span></span>
<span id="cb23-8"><a href="#cb23-8"></a>mlflow.set_experiment(EXPERIMENT_NAME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>&lt;Experiment: artifact_location='s3://mlflow-artifact-remote-storage/2', creation_time=1685548138856, experiment_id='2', last_update_time=1685548138856, lifecycle_stage='active', name='random-forest-best-models', tags={}&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Automatically log parameters and metrics</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>mlflow.sklearn.autolog()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># RandomForest Parameters</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>RF_PARAMS <span class="op">=</span> [<span class="st">'max_depth'</span>, <span class="st">'n_estimators'</span>, <span class="st">'min_samples_split'</span>,</span>
<span id="cb26-3"><a href="#cb26-3"></a>             <span class="st">'min_samples_leaf'</span>, <span class="st">'random_state'</span>, <span class="st">'n_jobs'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">def</span> train_and_log_model(params):</span>
<span id="cb27-2"><a href="#cb27-2"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="co">    Trains a RandomForestRegressor model with the given hyperparameters and logs evaluation metrics to MLflow.</span></span>
<span id="cb27-4"><a href="#cb27-4"></a></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="co">    Parameters:</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co">        params (dict): Dictionary of hyperparameters for RandomForestRegressor.</span></span>
<span id="cb27-7"><a href="#cb27-7"></a></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co">    Returns:</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="co">        None</span></span>
<span id="cb27-10"><a href="#cb27-10"></a></span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="co">    Notes:</span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="co">        - The function starts an MLflow run to track the model training and evaluation process.</span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="co">        - It converts certain hyperparameters to integers.</span></span>
<span id="cb27-14"><a href="#cb27-14"></a><span class="co">        - A RandomForestRegressor model is initialized with the provided hyperparameters.</span></span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="co">        - The model is trained on the training data.</span></span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="co">        - The trained model is evaluated on the validation and test sets, and the root mean squared error (RMSE) is calculated and logged to MLflow as evaluation metrics.</span></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="co">    """</span></span>
<span id="cb27-18"><a href="#cb27-18"></a></span>
<span id="cb27-19"><a href="#cb27-19"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb27-20"><a href="#cb27-20"></a>        <span class="co"># Convert specific hyperparameters to integers</span></span>
<span id="cb27-21"><a href="#cb27-21"></a>        <span class="cf">for</span> param <span class="kw">in</span> RF_PARAMS:</span>
<span id="cb27-22"><a href="#cb27-22"></a>            params[param] <span class="op">=</span> <span class="bu">int</span>(params[param])</span>
<span id="cb27-23"><a href="#cb27-23"></a></span>
<span id="cb27-24"><a href="#cb27-24"></a>        <span class="co"># Initialize a RandomForestRegressor model with the given hyperparameters</span></span>
<span id="cb27-25"><a href="#cb27-25"></a>        rf <span class="op">=</span> RandomForestRegressor(<span class="op">**</span>params)</span>
<span id="cb27-26"><a href="#cb27-26"></a></span>
<span id="cb27-27"><a href="#cb27-27"></a>        <span class="co"># Train the model on the training data</span></span>
<span id="cb27-28"><a href="#cb27-28"></a>        rf.fit(X_train, y_train)</span>
<span id="cb27-29"><a href="#cb27-29"></a></span>
<span id="cb27-30"><a href="#cb27-30"></a>        <span class="co"># Evaluate the trained model on the validation set</span></span>
<span id="cb27-31"><a href="#cb27-31"></a>        val_rmse <span class="op">=</span> mean_squared_error(y_val, rf.predict(X_val), squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb27-32"><a href="#cb27-32"></a></span>
<span id="cb27-33"><a href="#cb27-33"></a>        <span class="co"># Log the validation RMSE metric to MLflow</span></span>
<span id="cb27-34"><a href="#cb27-34"></a>        mlflow.log_metric(<span class="st">"val_rmse"</span>, val_rmse)</span>
<span id="cb27-35"><a href="#cb27-35"></a></span>
<span id="cb27-36"><a href="#cb27-36"></a>        <span class="co"># Evaluate the trained model on the test set</span></span>
<span id="cb27-37"><a href="#cb27-37"></a>        test_rmse <span class="op">=</span> mean_squared_error(y_test, rf.predict(X_test), squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb27-38"><a href="#cb27-38"></a></span>
<span id="cb27-39"><a href="#cb27-39"></a>        <span class="co"># Log the test RMSE metric to MLflow</span></span>
<span id="cb27-40"><a href="#cb27-40"></a>        mlflow.log_metric(<span class="st">"test_rmse"</span>, test_rmse)</span>
<span id="cb27-41"><a href="#cb27-41"></a></span>
<span id="cb27-42"><a href="#cb27-42"></a><span class="kw">def</span> run_register_model(top_n: <span class="bu">int</span>):</span>
<span id="cb27-43"><a href="#cb27-43"></a>    <span class="co">"""</span></span>
<span id="cb27-44"><a href="#cb27-44"></a><span class="co">    Runs the process to register the best model based on the top_n model runs with the lowest test RMSE.</span></span>
<span id="cb27-45"><a href="#cb27-45"></a></span>
<span id="cb27-46"><a href="#cb27-46"></a><span class="co">    Parameters:</span></span>
<span id="cb27-47"><a href="#cb27-47"></a><span class="co">        top_n (int): The number of top model runs to consider.</span></span>
<span id="cb27-48"><a href="#cb27-48"></a></span>
<span id="cb27-49"><a href="#cb27-49"></a><span class="co">    Returns:</span></span>
<span id="cb27-50"><a href="#cb27-50"></a><span class="co">        None</span></span>
<span id="cb27-51"><a href="#cb27-51"></a></span>
<span id="cb27-52"><a href="#cb27-52"></a><span class="co">    Notes:</span></span>
<span id="cb27-53"><a href="#cb27-53"></a><span class="co">        - The function interacts with the MLflow tracking server to retrieve and register models.</span></span>
<span id="cb27-54"><a href="#cb27-54"></a><span class="co">        - It retrieves the top_n model runs based on the lowest validation RMSE.</span></span>
<span id="cb27-55"><a href="#cb27-55"></a><span class="co">        - For each run, it trains a model using the hyperparameters from the run and logs evaluation metrics to MLflow.</span></span>
<span id="cb27-56"><a href="#cb27-56"></a><span class="co">        - After evaluating the models, it selects the one with the lowest test RMSE.</span></span>
<span id="cb27-57"><a href="#cb27-57"></a><span class="co">        - The selected model is registered with a specified name in MLflow.</span></span>
<span id="cb27-58"><a href="#cb27-58"></a><span class="co">    """</span></span>
<span id="cb27-59"><a href="#cb27-59"></a></span>
<span id="cb27-60"><a href="#cb27-60"></a>    <span class="co"># Connect to the MLflow tracking server</span></span>
<span id="cb27-61"><a href="#cb27-61"></a>    client <span class="op">=</span> MlflowClient()</span>
<span id="cb27-62"><a href="#cb27-62"></a></span>
<span id="cb27-63"><a href="#cb27-63"></a>    <span class="co"># Retrieve the top_n model runs and log the models</span></span>
<span id="cb27-64"><a href="#cb27-64"></a>    experiment <span class="op">=</span> client.get_experiment_by_name(HPO_EXPERIMENT_NAME)</span>
<span id="cb27-65"><a href="#cb27-65"></a></span>
<span id="cb27-66"><a href="#cb27-66"></a>    <span class="co"># Retrieve the top_n model runs based on the lowest validation RMSE</span></span>
<span id="cb27-67"><a href="#cb27-67"></a>    runs <span class="op">=</span> client.search_runs(</span>
<span id="cb27-68"><a href="#cb27-68"></a>        experiment_ids<span class="op">=</span>experiment.experiment_id,</span>
<span id="cb27-69"><a href="#cb27-69"></a>        run_view_type<span class="op">=</span>ViewType.ACTIVE_ONLY,</span>
<span id="cb27-70"><a href="#cb27-70"></a>        max_results<span class="op">=</span>top_n,</span>
<span id="cb27-71"><a href="#cb27-71"></a>        order_by<span class="op">=</span>[<span class="st">"metrics.rmse ASC"</span>]</span>
<span id="cb27-72"><a href="#cb27-72"></a>    )</span>
<span id="cb27-73"><a href="#cb27-73"></a></span>
<span id="cb27-74"><a href="#cb27-74"></a>    <span class="co"># Train and log the model for each run</span></span>
<span id="cb27-75"><a href="#cb27-75"></a>    <span class="cf">for</span> run <span class="kw">in</span> runs:</span>
<span id="cb27-76"><a href="#cb27-76"></a>        <span class="co"># Train and log the model based on the hyperparameters from the run</span></span>
<span id="cb27-77"><a href="#cb27-77"></a>        train_and_log_model(params<span class="op">=</span>run.data.params)</span>
<span id="cb27-78"><a href="#cb27-78"></a></span>
<span id="cb27-79"><a href="#cb27-79"></a>    <span class="co"># Select the model with the lowest test RMSE</span></span>
<span id="cb27-80"><a href="#cb27-80"></a>    experiment <span class="op">=</span> client.get_experiment_by_name(EXPERIMENT_NAME)</span>
<span id="cb27-81"><a href="#cb27-81"></a></span>
<span id="cb27-82"><a href="#cb27-82"></a>    <span class="co"># Retrieve model runs based on the lowest test RMSE, and select the first run (with the lowest test RMSE)</span></span>
<span id="cb27-83"><a href="#cb27-83"></a>    best_run <span class="op">=</span> client.search_runs(</span>
<span id="cb27-84"><a href="#cb27-84"></a>        experiment_ids<span class="op">=</span>experiment.experiment_id,</span>
<span id="cb27-85"><a href="#cb27-85"></a>        run_view_type<span class="op">=</span>ViewType.ACTIVE_ONLY,</span>
<span id="cb27-86"><a href="#cb27-86"></a>        order_by<span class="op">=</span>[<span class="st">"metrics.test_rmse ASC"</span>]</span>
<span id="cb27-87"><a href="#cb27-87"></a>    )[<span class="dv">0</span>]</span>
<span id="cb27-88"><a href="#cb27-88"></a></span>
<span id="cb27-89"><a href="#cb27-89"></a>    <span class="co"># Register the best model</span></span>
<span id="cb27-90"><a href="#cb27-90"></a>    model_uri <span class="op">=</span> <span class="ss">f"runs:/</span><span class="sc">{</span>best_run<span class="sc">.</span>info<span class="sc">.</span>run_id<span class="sc">}</span><span class="ss">/model"</span></span>
<span id="cb27-91"><a href="#cb27-91"></a></span>
<span id="cb27-92"><a href="#cb27-92"></a>    <span class="co"># Register the best model with a specified name</span></span>
<span id="cb27-93"><a href="#cb27-93"></a>    mlflow.register_model(</span>
<span id="cb27-94"><a href="#cb27-94"></a>        model_uri<span class="op">=</span>model_uri,</span>
<span id="cb27-95"><a href="#cb27-95"></a>        name<span class="op">=</span><span class="st">"random-forest-best-model"</span></span>
<span id="cb27-96"><a href="#cb27-96"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># The number of top model runs to consider</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>top_n <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb28-3"><a href="#cb28-3"></a></span>
<span id="cb28-4"><a href="#cb28-4"></a>run_register_model(top_n<span class="op">=</span>top_n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2023/05/31 11:58:21 WARNING mlflow.utils.autologging_utils: MLflow autologging encountered a warning: "/Users/wizard/Astronaut/Dev/MLOps/week2/venv/lib/python3.9/site-packages/_distutils_hack/__init__.py:33: UserWarning: Setuptools is replacing distutils."
Successfully registered model 'random-forest-best-model'.
2023/05/31 11:58:49 INFO mlflow.tracking._model_registry.client: Waiting up to 300 seconds for model version to finish creation. Model name: random-forest-best-model, version 1
Created version '1' of model 'random-forest-best-model'.</code></pre>
</div>
</div>
<p><img src="./images/aws_mlflow/best_test_models.png" class="img-fluid"></p>
<p>Congratulations! 🎉 You have successfully set up MLflow on AWS EC2 instance and used it to track your machine learning experiments.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
STOP EC2 instance
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please remember to stop the EC2 instance after completing your work to avoid incurring any additional charges.</p>
</div>
</div>
<p>Thank you for reading and I hope you found this post helpful. Upvote if you liked it, comment if you loved it. Hope to see you guys in the next one. Peace!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("(?:http:|https:)\/\/(www\.)?sagarthacker\.com\/*|javascript\:void\(0\)");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          // default icon
          link.classList.add("external");
      }
    }
});
</script>
<script src="https://giscus.app/client.js" data-repo="sagar118/sagarthacker" data-repo-id="R_kgDOIPm5_Q" data-category="General" data-category-id="DIC_kwDOIPm5_c4CXlxO" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" data-loading="lazy" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Made with <a href="https://quarto.org/">Quarto</a>, by Sagar Thacker. License: <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.github.com/sagar118">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/sagar-thacker/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:sagar+site@sagarthacker.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>